{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      if (myEnableDartSupportCheckBox.isSelected()) {
        final String sdkHomePath=FileUtilRt.toSystemIndependentName(mySdkPathTextWithBrowse.getText().trim());
        final String initialSdkHomePath=mySdkInitial == null ? "" : mySdkInitial.getHomePath();
        if (DartSdkUtil.isDartSdkHome(sdkHomePath)) {
          final String dartSdkGlobalLibName;
          if (mySdkInitial == null) {
            dartSdkGlobalLibName=DartSdkGlobalLibUtil.createDartSdkGlobalLib(myProject,sdkHomePath);
          }
 else {
            dartSdkGlobalLibName=mySdkInitial.getGlobalLibName();
            if (!sdkHomePath.equals(initialSdkHomePath)) {
              DartSdkGlobalLibUtil.updateDartSdkGlobalLib(myProject,dartSdkGlobalLibName,sdkHomePath);
            }
          }
          final Module[] modules=DartSdkGlobalLibUtil.isIdeWithMultipleModuleSupport() ? myModulesCheckboxTree.getCheckedNodes(Module.class,null) : ModuleManager.getInstance(myProject).getModules();
          DartSdkGlobalLibUtil.updateDependencyOnDartSdkGlobalLib(myProject,modules,dartSdkGlobalLibName);
        }
        final String dartiumPath=FileUtilRt.toSystemIndependentName(myDartiumPathTextWithBrowse.getText().trim());
        DartiumUtil.applyDartiumSettings(dartiumPath,myDartiumSettingsCurrent);
      }
 else {
        if (myModulesWithDartSdkLibAttachedInitial.size() > 0 && mySdkInitial != null) {
          DartSdkGlobalLibUtil.detachDartSdkGlobalLib(myModulesWithDartSdkLibAttachedInitial,mySdkInitial.getGlobalLibName());
        }
      }
    }
  }
);
  reset();
}
