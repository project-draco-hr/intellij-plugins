{
  final Runnable runnable=new Runnable(){
    @Override public void run(){
      if (myEnableDartSupportCheckBox.isSelected()) {
        final String sdkHomePath=FileUtilRt.toSystemIndependentName(mySdkPathTextWithBrowse.getText().trim());
        if (DartSdkUtil.isDartSdkHome(sdkHomePath)) {
          DartSdkGlobalLibUtil.ensureDartSdkConfigured(sdkHomePath);
          DaemonCodeAnalyzer.getInstance(myProject).restart();
          final Module[] modules=DartSdkGlobalLibUtil.isIdeWithMultipleModuleSupport() ? myModulesCheckboxTreeTable.getCheckedNodes(Module.class) : ModuleManager.getInstance(myProject).getModules();
          DartSdkGlobalLibUtil.enableDartSdkForSpecifiedModulesAndDisableForOthers(myProject,modules);
          for (          Module module : ModuleManager.getInstance(myProject).getModules()) {
            if (ArrayUtil.contains(module,modules)) {
              final String customPackageRoot=DartSdkGlobalLibUtil.isIdeWithMultipleModuleSupport() || myCustomPackageRootCheckBox.isSelected() ? myModuleToCustomPackageRootCurrent.get(module) : null;
              setCustomPackageRootPath(module,customPackageRoot);
            }
 else {
              setCustomPackageRootPath(module,null);
            }
          }
        }
        final DartSdkUpdateOption sdkUpdateOption=myCheckSdkUpdateCheckBox.isSelected() ? (DartSdkUpdateOption)mySdkUpdateChannelCombo.getSelectedItem() : DartSdkUpdateOption.DoNotCheck;
        DartSdkUpdateOption.setDartSdkUpdateOption(sdkUpdateOption);
        final String dartiumPath=FileUtilRt.toSystemIndependentName(myDartiumPathTextWithBrowse.getText().trim());
        DartiumUtil.applyDartiumSettings(dartiumPath,myDartiumSettingsCurrent);
      }
 else {
        if (myModulesWithDartSdkLibAttachedInitial.size() > 0 && mySdkInitial != null) {
          DartSdkGlobalLibUtil.disableDartSdk(myModulesWithDartSdkLibAttachedInitial);
        }
        for (        final Module module : ModuleManager.getInstance(myProject).getModules()) {
          setCustomPackageRootPath(module,null);
        }
      }
    }
  }
;
  ApplicationManager.getApplication().runWriteAction(runnable);
  reset();
}
