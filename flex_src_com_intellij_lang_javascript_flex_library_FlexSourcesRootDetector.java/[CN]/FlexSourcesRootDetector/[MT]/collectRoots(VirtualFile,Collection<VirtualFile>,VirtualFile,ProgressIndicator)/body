{
  progressIndicator.checkCanceled();
  progressIndicator.setText2(file.getPresentableUrl());
  String extension;
  if (!file.isDirectory() && ((extension=file.getExtension()) != null)) {
    if (JavaScriptSupportLoader.ECMA_SCRIPT_L4.equals(JavaScriptSupportLoader.getLanguageDialect(extension))) {
      Pair<VirtualFile,String> root=CommonSourceRootDetectionUtil.VIRTUAL_FILE.suggestRootForFileWithPackageStatement(file,topmostRoot,FlexProjectStructureDetector.PACKAGE_NAME_FETCHER,false);
      if (root != null) {
        result.add(root.first);
        return root.first;
      }
    }
 else     if (myDetectMxml && JavaScriptSupportLoader.isFlexMxmFile(file.getName())) {
      result.add(file.getParent());
      return null;
    }
  }
  for (  VirtualFile child : file.getChildren()) {
    VirtualFile detectedRoot=collectRoots(child,result,topmostRoot,progressIndicator);
    if (detectedRoot != null) {
      if (VfsUtilCore.isAncestor(detectedRoot,file,false)) {
        return detectedRoot;
      }
    }
  }
  return null;
}
