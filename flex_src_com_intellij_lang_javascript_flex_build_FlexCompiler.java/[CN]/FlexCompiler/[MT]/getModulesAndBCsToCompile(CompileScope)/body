{
  final Collection<Pair<Module,FlexIdeBuildConfiguration>> result=new HashSet<Pair<Module,FlexIdeBuildConfiguration>>();
  final Collection<Pair<Module,FlexIdeBuildConfiguration>> modulesAndBCsToCompile=scope.getUserData(MODULES_AND_BCS_TO_COMPILE);
  final RunConfiguration runConfiguration=CompileStepBeforeRun.getRunConfiguration(scope);
  if (modulesAndBCsToCompile != null) {
    for (    Pair<Module,FlexIdeBuildConfiguration> moduleAndBC : modulesAndBCsToCompile) {
      if (!moduleAndBC.second.isSkipCompile()) {
        final FlexIdeBuildConfiguration bcWithForcedDebugStatus=forceDebugStatus(moduleAndBC.first.getProject(),moduleAndBC.second);
        result.add(Pair.create(moduleAndBC.first,bcWithForcedDebugStatus));
        appendBCDependencies(result,moduleAndBC.first,moduleAndBC.second);
      }
    }
  }
 else   if (runConfiguration instanceof FlashRunConfiguration || runConfiguration instanceof FlexUnitRunConfiguration) {
    final BCBasedRunnerParameters params=runConfiguration instanceof FlashRunConfiguration ? ((FlashRunConfiguration)runConfiguration).getRunnerParameters() : ((FlexUnitRunConfiguration)runConfiguration).getRunnerParameters();
    final Pair<Module,FlexIdeBuildConfiguration> moduleAndBC;
    final Ref<RuntimeConfigurationError> exceptionRef=new Ref<RuntimeConfigurationError>();
    moduleAndBC=ApplicationManager.getApplication().runReadAction(new NullableComputable<Pair<Module,FlexIdeBuildConfiguration>>(){
      public Pair<Module,FlexIdeBuildConfiguration> compute(){
        try {
          return params.checkAndGetModuleAndBC(runConfiguration.getProject());
        }
 catch (        RuntimeConfigurationError e) {
          exceptionRef.set(e);
          return null;
        }
      }
    }
);
    if (!exceptionRef.isNull()) {
      throw new ConfigurationException(exceptionRef.get().getMessage(),FlexBundle.message("run.configuration.0",runConfiguration.getName()));
    }
    if (!moduleAndBC.second.isSkipCompile()) {
      result.add(moduleAndBC);
      appendBCDependencies(result,moduleAndBC.first,moduleAndBC.second);
    }
  }
 else {
    for (    final Module module : scope.getAffectedModules()) {
      if (ModuleType.get(module) != FlexModuleType.getInstance())       continue;
      for (      final FlexIdeBuildConfiguration bc : FlexBuildConfigurationManager.getInstance(module).getBuildConfigurations()) {
        if (!bc.isSkipCompile()) {
          result.add(Pair.create(module,bc));
        }
      }
    }
  }
  return result;
}
