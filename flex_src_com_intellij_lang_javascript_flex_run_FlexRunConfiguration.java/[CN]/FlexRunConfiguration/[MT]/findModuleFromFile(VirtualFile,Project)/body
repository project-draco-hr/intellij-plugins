{
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  Module moduleForFile=fileIndex.getModuleForFile(file);
  while (moduleForFile == null && fileIndex.isIgnored(file)) {
    file=file.getParent();
    if (file == null)     break;
    moduleForFile=fileIndex.getModuleForFile(file);
  }
  return moduleForFile;
}
