{
  for (  Module module : myModule2Editors.keySet()) {
    ModifiableRootModel modifiableModel=myProvider.getModuleModifiableModel(module);
    Map<LibraryEx,Boolean> librariesToAdd=new HashMap<LibraryEx,Boolean>();
    Collection<String> sdksNames=new HashSet<String>();
    for (    Editor editor : myModule2Editors.get(module)) {
      final SdkEntry sdkEntry=editor.getDependencies().getSdkEntry();
      if (sdkEntry != null) {
        sdksNames.add(sdkEntry.getName());
      }
      for (      DependencyEntry dependencyEntry : editor.getDependencies().getEntries()) {
        if (dependencyEntry instanceof SharedLibraryEntry) {
          SharedLibraryEntry sharedLibraryEntry=(SharedLibraryEntry)dependencyEntry;
          LibraryTableBase.ModifiableModelEx m=myProvider.getLibrariesModifiableModel(sharedLibraryEntry.getLibraryLevel());
          LibraryEx library=(LibraryEx)m.getLibraryByName(sharedLibraryEntry.getLibraryName());
          if (library != null) {
            librariesToAdd.put(library,true);
          }
        }
      }
    }
    modifiableModel.setSdk(sdksNames.isEmpty() ? null : new FlexCompositeSdk(sdksNames));
    Collection<OrderEntry> entriesToRemove=new ArrayList<OrderEntry>();
    for (    OrderEntry orderEntry : modifiableModel.getOrderEntries()) {
      if (orderEntry instanceof LibraryOrderEntry) {
        if (((LibraryOrderEntry)orderEntry).isModuleLevel()) {
          continue;
        }
        LibraryEx library=(LibraryEx)((LibraryOrderEntry)orderEntry).getLibrary();
        if (librariesToAdd.containsKey(library)) {
          librariesToAdd.put(library,false);
        }
 else         if (library != null && (library.getType() instanceof FlexSdkLibraryType || FlexProjectRootsUtil.isFlexLibrary(library))) {
          entriesToRemove.add(orderEntry);
        }
      }
    }
    for (    OrderEntry e : entriesToRemove) {
      modifiableModel.removeOrderEntry(e);
    }
    for (    LibraryEx library : librariesToAdd.keySet()) {
      if (!library.isDisposed() && librariesToAdd.get(library) && myProvider.getLibrariesModifiableModel(library.getTable().getTableLevel()).getLibraryByName(library.getName()) != null) {
        modifiableModel.addLibraryEntry(library);
      }
    }
    final Map<Module,Boolean> modulesToAdd=new HashMap<Module,Boolean>();
    for (    Editor editor : myModule2Editors.get(module)) {
      for (      DependencyEntry dependencyEntry : editor.getDependencies().getEntries()) {
        if (dependencyEntry instanceof BuildConfigurationEntry) {
          Editor bc=findBc((BuildConfigurationEntry)dependencyEntry);
          if (bc != null && bc.myModule != module) {
            modulesToAdd.put(bc.myModule,true);
          }
        }
      }
    }
    List<OrderEntry> moduleOrderEntriesToRemove=ContainerUtil.filter(modifiableModel.getOrderEntries(),new Condition<OrderEntry>(){
      @Override public boolean value(      OrderEntry orderEntry){
        if (orderEntry instanceof ModuleOrderEntry) {
          Module m=((ModuleOrderEntry)orderEntry).getModule();
          if (modulesToAdd.containsKey(m)) {
            modulesToAdd.put(m,false);
            return false;
          }
 else {
            return true;
          }
        }
        return false;
      }
    }
);
    for (    OrderEntry orderEntry : moduleOrderEntriesToRemove) {
      modifiableModel.removeOrderEntry(orderEntry);
    }
    for (    Module m : modulesToAdd.keySet()) {
      if (modulesToAdd.get(m)) {
        modifiableModel.addModuleOrderEntry(m);
      }
    }
  }
  Collection<Module> modulesWithChangedModifiableModel=ContainerUtil.findAll(myModule2Editors.keySet(),new Condition<Module>(){
    @Override public boolean value(    Module module){
      return myProvider.getModuleModifiableModel(module).isChanged();
    }
  }
);
  if (!modulesWithChangedModifiableModel.isEmpty()) {
    myProvider.commitModifiableModels();
    myModulesModelChangeEventDispatcher.getMulticaster().modulesModelsChanged(modulesWithChangedModifiableModel);
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      for (      Module module : myModule2Editors.keySet()) {
        Function<Editor,FlexIdeBuildConfigurationImpl> f=new Function<Editor,FlexIdeBuildConfigurationImpl>(){
          @Override public FlexIdeBuildConfigurationImpl fun(          Editor editor){
            return editor.commit();
          }
        }
;
        FlexIdeBuildConfigurationImpl[] current=ContainerUtil.map2Array(myModule2Editors.get(module),FlexIdeBuildConfigurationImpl.class,f);
        ((FlexBuildConfigurationManagerImpl)FlexBuildConfigurationManager.getInstance(module)).setBuildConfigurations(current);
      }
      if (myProject != null) {
        FlexBuildConfigurationManagerImpl.resetHighlighting(myProject);
      }
    }
  }
);
}
