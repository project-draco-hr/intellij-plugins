{
  if (packagesFolder != null)   packagesFolder=packagesFolder.getCanonicalFile();
  final Pair<String,VirtualFile> key=Pair.create(sdkPath,packagesFolder);
  AnalysisContext context=mySdkPathAndPackagesDirToAnalysisContext.get(key);
  if (context == null) {
    final DartUriResolver dartUriResolver=new DartUriResolver(new DirectoryBasedDartSdk(new File(sdkPath)));
    final UriResolver fileResolver=new DartFileResolver(myProject);
    final SourceFactory sourceFactory=packagesFolder == null ? new SourceFactory(dartUriResolver,fileResolver) : new SourceFactory(dartUriResolver,fileResolver,new PackageUriResolver(new File(packagesFolder.getPath())));
    context=AnalysisEngine.getInstance().createAnalysisContext();
    context.setSourceFactory(sourceFactory);
    mySdkPathAndPackagesDirToAnalysisContext.put(key,context);
  }
 else {
    applyChangeSet(context);
    myCreatedFiles.clear();
  }
  return context;
}
