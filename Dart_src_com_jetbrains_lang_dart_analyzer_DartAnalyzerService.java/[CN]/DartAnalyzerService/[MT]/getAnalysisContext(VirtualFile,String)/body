{
  AnalysisContext analysisContext=SoftReference.dereference(myAnalysisContextRef);
  final List<VirtualFile> packageRoots=PubspecYamlUtil.getDartPackageRoots(myProject,annotatedFile);
  if (analysisContext != null && Comparing.equal(sdkPath,mySdkPath) && Comparing.haveEqualElements(packageRoots,myDartPackageRoots)) {
    applyChangeSet(analysisContext,annotatedFile);
    myCreatedFiles.clear();
  }
 else {
    final DartUriResolver dartUriResolver=new DartUriResolver(new DirectoryBasedDartSdk(new File(sdkPath)));
    final UriResolver fileResolver=new DartFileUriResolver(myProject);
    final SourceFactory sourceFactory=new SourceFactory(dartUriResolver,fileResolver,new DartPackageUriResolver(myProject,annotatedFile));
    analysisContext=AnalysisEngine.getInstance().createAnalysisContext();
    analysisContext.setSourceFactory(sourceFactory);
    mySdkPath=sdkPath;
    myDartPackageRoots=packageRoots;
    myAnalysisContextRef=new WeakReference<AnalysisContext>(analysisContext);
  }
  return analysisContext;
}
