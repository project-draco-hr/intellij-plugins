{
  final boolean needToCommitModuleModel=model == null;
  final ModifiableModuleModel moduleModel=model != null ? model : ModuleManager.getInstance(project).getModifiableModel();
  final List<String> paths=getList();
  final boolean isArchive=paths.size() == 1 && FlashBuilderProjectFinder.hasArchiveExtension(paths.get(0));
  final List<String> dotProjectPaths=getDotProjectPaths(project);
  final List<FlashBuilderProject> flashBuilderProjects=FlashBuilderProjectLoadUtil.loadProjects(dotProjectPaths,isArchive);
  final ModuleType moduleType=PlatformUtils.isFlexIde() ? FlexModuleType.getInstance() : StdModuleTypes.JAVA;
  final Map<FlashBuilderProject,ModifiableRootModel> flashBuilderProjectToModifiableModelMap=new THashMap<FlashBuilderProject,ModifiableRootModel>();
  final Map<Module,ModifiableRootModel> moduleToModifiableModelMap=new THashMap<Module,ModifiableRootModel>();
  final Set<String> moduleNames=new THashSet<String>(flashBuilderProjects.size());
  final FlexProjectConfigurationEditor currentFlexEditor=PlatformUtils.isFlexIde() ? FlexBuildConfigurationsExtension.getInstance().getConfigurator().getConfigEditor() : null;
  for (  FlashBuilderProject flashBuilderProject : flashBuilderProjects) {
    final String moduleName=makeUnique(flashBuilderProject.getName(),moduleNames);
    moduleNames.add(moduleName);
    final String moduleFilePath=flashBuilderProject.getProjectRootPath() + "/" + moduleName+ ModuleFileType.DOT_DEFAULT_EXTENSION;
    if (LocalFileSystem.getInstance().findFileByPath(moduleFilePath) != null) {
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          ModuleBuilder.deleteModuleFile(moduleFilePath);
        }
      }
);
    }
    final Module module=moduleModel.newModule(moduleFilePath,moduleType);
    final ModifiableRootModel rootModel;
    if (PlatformUtils.isFlexIde() && currentFlexEditor != null) {
      rootModel=currentFlexEditor.getModifiableRootModel(module);
    }
 else {
      rootModel=ModuleRootManager.getInstance(module).getModifiableModel();
    }
    flashBuilderProjectToModifiableModelMap.put(flashBuilderProject,rootModel);
    moduleToModifiableModelMap.put(module,rootModel);
  }
  final FlexProjectConfigurationEditor flexConfigEditor;
  final boolean needToCommitFlexEditor;
  final boolean needToCommitRootModels;
  if (!PlatformUtils.isFlexIde()) {
    flexConfigEditor=null;
    needToCommitFlexEditor=false;
    needToCommitRootModels=true;
  }
 else   if (currentFlexEditor != null) {
    flexConfigEditor=currentFlexEditor;
    needToCommitFlexEditor=false;
    needToCommitRootModels=false;
  }
 else {
    flexConfigEditor=FlexProjectConfigurationEditor.createEditor(project,moduleToModifiableModelMap,null,null);
    needToCommitFlexEditor=true;
    needToCommitRootModels=true;
  }
  if (needToCommitModuleModel) {
    assert needToCommitRootModels;
  }
  final FlashBuilderSdkFinder sdkFinder=new FlashBuilderSdkFinder(project,flexConfigEditor,getParameters().myInitiallySelectedPath,flashBuilderProjects);
  final FlashBuilderModuleImporter flashBuilderModuleImporter=new FlashBuilderModuleImporter(project,flexConfigEditor,flashBuilderProjects,sdkFinder);
  for (  final FlashBuilderProject flashBuilderProject : flashBuilderProjects) {
    flashBuilderModuleImporter.setupModule(flashBuilderProjectToModifiableModelMap.get(flashBuilderProject),flashBuilderProject);
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      if (PlatformUtils.isFlexIde() && needToCommitFlexEditor) {
        try {
          flexConfigEditor.commit();
        }
 catch (        ConfigurationException e) {
          Logger.getInstance(FlashBuilderImporter.class).error(e);
        }
      }
      final Collection<ModifiableRootModel> rootModels=moduleToModifiableModelMap.values();
      if (needToCommitModuleModel) {
        ProjectRootManager.getInstance(project).multiCommit(moduleModel,rootModels.toArray(new ModifiableRootModel[rootModels.size()]));
      }
 else       if (needToCommitRootModels) {
        for (        ModifiableRootModel rootModel : rootModels) {
          rootModel.commit();
        }
      }
    }
  }
);
  return new ArrayList<Module>(moduleToModifiableModelMap.keySet());
}
