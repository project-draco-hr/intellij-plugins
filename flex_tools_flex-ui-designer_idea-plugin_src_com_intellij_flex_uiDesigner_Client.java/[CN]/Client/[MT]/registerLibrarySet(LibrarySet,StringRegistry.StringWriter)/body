{
  beginMessage(ClientMethod.registerLibrarySet);
  out.writeAmfUtf(librarySet.getId());
  out.writeInt(-1);
  stringWriter.writeTo(out);
  out.write(librarySet.getApplicationDomainCreationPolicy());
  out.writeShort(librarySet.getLibraries().size());
  for (  Library library : librarySet.getLibraries()) {
    final OriginalLibrary originalLibrary;
    final boolean unregisteredLibrary;
    if (library instanceof OriginalLibrary) {
      originalLibrary=(OriginalLibrary)library;
      unregisteredLibrary=originalLibrary.sessionId != sessionId;
      out.write(unregisteredLibrary ? 0 : 1);
    }
 else     if (library instanceof FilteredLibrary) {
      FilteredLibrary filteredLibrary=(FilteredLibrary)library;
      originalLibrary=filteredLibrary.getOrigin();
      unregisteredLibrary=originalLibrary.sessionId != sessionId;
      out.write(unregisteredLibrary ? 2 : 3);
    }
 else {
      out.write(4);
      out.writeNotEmptyString(((EmbedLibrary)library).getPath());
      continue;
    }
    if (unregisteredLibrary) {
      originalLibrary.id=registeredLibraryCounter++;
      originalLibrary.sessionId=sessionId;
      out.writeAmfUtf(originalLibrary.getPath());
      writeVirtualFile(originalLibrary.getFile(),out);
      writeNullableByteArray(originalLibrary.inheritingStyles);
      if (originalLibrary.defaultsStyle == null) {
        out.write(0);
      }
 else {
        out.write(1);
        out.write(originalLibrary.defaultsStyle);
      }
    }
 else {
      out.writeShort(originalLibrary.id);
    }
  }
  blockOut.end();
}
