{
  VirtualFile virtualFile=psiFile.getVirtualFile();
  final int factoryId=registerDocumentFactoryIfNeed(module,psiFile,virtualFile,false,problemsHolder);
  final AsyncResult<DocumentInfo> result=new AsyncResult<DocumentInfo>();
  if (factoryId == -1) {
    result.setRejected();
    return result;
  }
  FlexLibrarySet flexLibrarySet=registeredModules.getInfo(module).getFlexLibrarySet();
  if (flexLibrarySet != null) {
    fillAssetClassPoolIfNeed(flexLibrarySet);
  }
  if (!problemsHolder.isEmpty()) {
    DocumentProblemManager.getInstance().report(module.getProject(),problemsHolder);
  }
  final ActionCallback callback=new ActionCallback("renderDocument");
  boolean hasError=true;
  try {
    beginMessage(ClientMethod.renderDocument,callback,result,new Runnable(){
      @Override public void run(){
        result.setDone(DocumentFactoryManager.getInstance().getInfo(factoryId));
      }
    }
);
    out.writeShort(factoryId);
    hasError=false;
  }
  finally {
    finalizeMessageAndFlush(hasError);
  }
  return result;
}
