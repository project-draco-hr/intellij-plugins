{
  beginMessage(ClientMethod.registerLibrarySet);
  out.writeAmfUtf(librarySet.getId());
  LibrarySet parent=librarySet.getParent();
  if (parent == null) {
    out.write(0);
  }
 else {
    out.writeAmfUtf(parent.getId());
  }
  out.write(librarySet.getApplicationDomainCreationPolicy());
  final List<LibrarySetItem> items=librarySet.getItems();
  out.write(items.size());
  final LibraryManager libraryManager=LibraryManager.getInstance();
  for (  LibrarySetItem item : items) {
    final Library library=item.library;
    final boolean unregisteredLibrary=!libraryManager.isRegistered(library);
    int flags=item.filtered ? 1 : 0;
    if (unregisteredLibrary) {
      flags|=2;
    }
    out.write(flags);
    if (unregisteredLibrary) {
      out.writeShort(libraryManager.add(library));
      out.writeAmfUtf(library.getPath());
      writeVirtualFile(library.getFile(),out);
      if (library.inheritingStyles == null) {
        out.writeShort(0);
      }
 else {
        out.write(library.inheritingStyles);
      }
      if (library.defaultsStyle == null) {
        out.write(0);
      }
 else {
        out.write(1);
        out.write(library.defaultsStyle);
      }
    }
 else {
      out.writeShort(library.getId());
    }
    writeParents(items,item);
  }
  out.write(librarySet.getEmbedItems().size());
  for (  LibrarySetEmbedItem item : librarySet.getEmbedItems()) {
    out.write(items.indexOf(item.parent));
    out.writeAmfUtf(item.path);
  }
  blockOut.end();
}
