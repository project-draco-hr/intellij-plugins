{
  final List<LibrarySetItem> items=librarySet.getItems();
  if (items.isEmpty()) {
    return;
  }
  boolean hasError=true;
  try {
    beginMessage(ClientMethod.registerLibrarySet);
    out.writeUInt29(librarySet.getId());
    LibrarySet parent=librarySet.getParent();
    out.writeShort(parent == null ? -1 : parent.getId());
    out.write(items.size());
    final LibraryManager libraryManager=LibraryManager.getInstance();
    for (    LibrarySetItem item : items) {
      final Library library=item.library;
      final boolean registered=libraryManager.isRegistered(library);
      int flags=0;
      if (registered) {
        flags|=2;
      }
      out.write(flags);
      if (registered) {
        out.writeUInt29(library.getId());
      }
 else {
        out.writeShort(libraryManager.add(library));
        out.writeAmfUtf(library.getPath());
        writeVirtualFile(library.getFile(),out);
        if (library.inheritingStyles == null) {
          out.writeShort(0);
        }
 else {
          out.write(library.inheritingStyles);
        }
        if (library.defaultsStyle == null) {
          out.write(0);
        }
 else {
          out.write(1);
          out.write(library.defaultsStyle);
        }
      }
    }
    hasError=false;
  }
  finally {
    finalizeMessage(hasError);
  }
}
