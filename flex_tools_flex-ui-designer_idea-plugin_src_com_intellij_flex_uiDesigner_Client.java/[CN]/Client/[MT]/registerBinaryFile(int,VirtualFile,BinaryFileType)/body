{
  int length=(int)file.getLength();
  ImageWrapper imageWrapper=null;
  if (type == BinaryFileType.IMAGE) {
    imageWrapper=new ImageWrapper(length);
    length=imageWrapper.getLength();
  }
  OutputStream directOut=blockOut.writeUnbufferedHeader(2 + 1 + 2+ 4+ length);
  directOut.write(ClientMethod.METHOD_CLASS);
  directOut.write(ClientMethod.registerBinaryFile.ordinal());
  directOut.write(type.ordinal());
  directOut.write((id >>> 8) & 0xFF);
  directOut.write(id & 0xFF);
  directOut.write((length >>> 24) & 0xFF);
  directOut.write((length >>> 16) & 0xFF);
  directOut.write((length >>> 8) & 0xFF);
  directOut.write(length & 0xFF);
  final InputStream inputStream=file.getInputStream();
  try {
    if (type == BinaryFileType.IMAGE) {
      imageWrapper.wrap(inputStream,directOut);
    }
 else {
      FileUtil.copy(inputStream,directOut);
    }
  }
  finally {
    inputStream.close();
  }
}
