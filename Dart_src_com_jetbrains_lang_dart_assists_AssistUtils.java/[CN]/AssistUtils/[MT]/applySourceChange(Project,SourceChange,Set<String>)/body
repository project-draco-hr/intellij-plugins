{
  final Map<VirtualFile,SourceFileEdit> changeMap=getContentFilesChanges(project,sourceChange,excludedIds);
{
    final Set<VirtualFile> files=changeMap.keySet();
    final boolean okToWrite=FileModificationService.getInstance().prepareVirtualFilesForWrite(project,files);
    if (!okToWrite) {
      return;
    }
  }
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    @Override public void run(){
      for (      Map.Entry<VirtualFile,SourceFileEdit> entry : changeMap.entrySet()) {
        final VirtualFile file=entry.getKey();
        final SourceFileEdit fileEdit=entry.getValue();
        applyFileEdit(file,fileEdit,excludedIds);
      }
      runLinkedEdits(project,sourceChange);
    }
  }
,sourceChange.getMessage(),null);
}
