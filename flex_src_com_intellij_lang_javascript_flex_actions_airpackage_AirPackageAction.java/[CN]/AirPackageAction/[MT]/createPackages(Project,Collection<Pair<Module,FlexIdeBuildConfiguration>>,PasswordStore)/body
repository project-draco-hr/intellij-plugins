{
  final Collection<Pair<ExternalTask,String>> tasksAndPackagePaths=new ArrayList<Pair<ExternalTask,String>>();
  final AirPackageProjectParameters params=AirPackageProjectParameters.getInstance(project);
  for (  Pair<Module,FlexIdeBuildConfiguration> moduleAndBC : modulesAndBCs) {
    final FlexIdeBuildConfiguration bc=moduleAndBC.second;
    final String outputFolder=PathUtil.getParentPath(bc.getActualOutputFilePath());
    if (bc.getTargetPlatform() == TargetPlatform.Desktop) {
      if (bc.getAirDesktopPackagingOptions().getSigningOptions().isUseTempCertificate() && !AirPackageUtil.ensureCertificateExists(project,bc.getSdk())) {
        return;
      }
      final DesktopPackageType packageType=params.desktopPackageType;
      final ExternalTask task=AirPackageUtil.createAirDesktopTask(moduleAndBC.first,bc,packageType,passwords);
      final String packagePath=outputFolder + "/" + bc.getAirDesktopPackagingOptions().getPackageFileName()+ packageType.getFileExtension();
      tasksAndPackagePaths.add(Pair.create(task,packagePath));
    }
 else {
      if (bc.getAndroidPackagingOptions().isEnabled()) {
        final AndroidPackagingOptions packagingOptions=bc.getAndroidPackagingOptions();
        if (packagingOptions.getSigningOptions().isUseTempCertificate() && !AirPackageUtil.ensureCertificateExists(project,bc.getSdk())) {
          return;
        }
        final AndroidPackageType packageType=params.androidPackageType;
        final ExternalTask task=AirPackageUtil.createAndroidPackageTask(moduleAndBC.first,bc,packageType,params.apkCaptiveRuntime,params.apkDebugListenPort,passwords);
        final String packagePath=outputFolder + "/" + packagingOptions.getPackageFileName()+ ".apk";
        tasksAndPackagePaths.add(Pair.create(task,packagePath));
      }
      if (bc.getIosPackagingOptions().isEnabled()) {
        final IosPackagingOptions packagingOptions=bc.getIosPackagingOptions();
        final IOSPackageType packageType=params.iosPackageType;
        final ExternalTask task=AirPackageUtil.createIOSPackageTask(moduleAndBC.first,bc,packageType,params.iosFastPackaging,passwords);
        final String packagePath=outputFolder + "/" + packagingOptions.getPackageFileName()+ ".ipa";
        tasksAndPackagePaths.add(Pair.create(task,packagePath));
      }
    }
  }
  createPackages(project,tasksAndPackagePaths);
}
