{
  int runnerPort=-1;
  if (server.isReady()) {
    runnerPort=server.getRunnerPort();
  }
  File clientAppFile;
  try {
    clientAppFile=server.getClientAppFile();
  }
 catch (  IOException e) {
    throw new ExecutionException("Can't find karma-intellij test runner",e);
  }
  GeneralCommandLine commandLine=createCommandLine(runnerPort,clientAppFile);
  Process process=commandLine.createProcess();
  final ProcessHandler processHandler=new KillableColoredProcessHandler(process,commandLine.getCommandLineString());
  ProcessTerminatedListener.attach(processHandler);
  if (runnerPort == -1) {
    server.addListener(new KarmaServerListener(){
      @Override public void onReady(      int webServerPort,      int runnerPort){
        @SuppressWarnings("IOResourceOpenedButNotSafelyClosed") PrintWriter pw=new PrintWriter(processHandler.getProcessInput(),false);
        pw.print("runner port " + runnerPort + "\n");
        pw.flush();
      }
    }
);
  }
  return processHandler;
}
