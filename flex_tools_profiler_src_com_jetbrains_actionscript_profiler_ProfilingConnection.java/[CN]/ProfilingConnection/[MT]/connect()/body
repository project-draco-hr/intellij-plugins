{
  myAbortingSocketConnection=false;
  myDisposed=false;
  ensurePolicyServedEvenOnFlashSecurityPort();
  try {
    myServerSocket=new ServerSocket(myPort);
    Socket socket=myServerSocket.accept();
    myInputStream=new DataInputStream(new BufferedInputStream(socket.getInputStream()));
    myOutputStream=socket.getOutputStream();
    myServerSocket.close();
    myServerSocket=null;
    myIoHandler.finished("Connection established",null);
  }
 catch (  IOException ex) {
    final boolean abortedWaitingForConnection=ex instanceof SocketException && myAbortingSocketConnection;
    if (abortedWaitingForConnection) {
      ex=new EOFException("aborted wait for connection");
    }
 else {
      Logging.log(ex);
    }
    myIoHandler.finished(null,ex);
    return;
  }
  ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
    public void run(){
      ByteArrayOutputStream out=Logging.doStat ? new ByteArrayOutputStream() : null;
      int bytesRead=0;
      try {
        while (true) {
          String x=myInputStream.readUTF();
          if (x == null)           break;
          if (out != null)           out.write(x.getBytes());
          bytesRead+=x.length();
          try {
            if (myCurrentPacketProcessor == null) {
              String marker=x;
              int i=x.indexOf('\0');
              if (i != -1)               marker=x.substring(0,i + 1);
              myCurrentPacketProcessor=myInitialString2ProcessorsMap.get(marker);
              if (myCurrentPacketProcessor != null) {
                myCurrentPacketProcessor.startingPacket(x);
              }
            }
            if (myCurrentPacketProcessor != null) {
              PacketProcessor.ProcessingResult processingResult=myCurrentPacketProcessor.process(x);
              if (processingResult == PacketProcessor.ProcessingResult.FINISHED)               myCurrentPacketProcessor=null;
              if (processingResult == PacketProcessor.ProcessingResult.STOP)               return;
            }
 else {
              Logging.log("No processing:" + x);
            }
          }
 catch (          Exception e) {
            Logging.log(e);
          }
        }
      }
 catch (      IOException ex) {
        Logging.log("Bytes read:" + bytesRead);
        myIoHandler.finished(null,ex);
        if (ex instanceof EOFException) {
          if (out != null) {
            try {
              final FileOutputStream fileOutputStream=new FileOutputStream("c:\\trace");
              fileOutputStream.write(out.toByteArray());
              fileOutputStream.close();
            }
 catch (            IOException e) {
              Logging.log(e);
            }
          }
          return;
        }
        Logging.log(ex);
      }
catch (      Throwable t) {
        Logging.log(t);
      }
    }
  }
);
}
