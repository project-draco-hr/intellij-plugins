{
  final String key=createKey(libraryCollector.sdkLibraries);
  FlexLibrarySet flexLibrarySet=(FlexLibrarySet)librarySets.get(key);
  if (flexLibrarySet == null) {
    final Set<CharSequence> globalDefinitions=getGlobalDefinitions(libraryCollector.getGlobalLibrary());
    final int id=librarySetIdPool.allocate();
    Condition<String> globalContains=new Condition<String>(){
      @Override public boolean value(      String name){
        return globalDefinitions.contains(name);
      }
    }
;
    final SortResult sortResult=sortLibraries(new LibrarySorter(new FlexDefinitionProcessor(libraryCollector.getFlexSdkVersion()),new FlexDefinitionMapProcessor(libraryCollector.getFlexSdkVersion(),globalContains)),id,libraryCollector.sdkLibraries,libraryCollector.getFlexSdkVersion(),globalContains);
    flexLibrarySet=new FlexLibrarySet(id,null,sortResult.items,sortResult.resourceBundleOnlyItems,new ContainsCondition(globalDefinitions,sortResult.definitionMap));
    registerLibrarySet(key,flexLibrarySet);
  }
  return flexLibrarySet;
}
