{
  final String key=createKey(libraryCollector.sdkLibraries);
  FlexLibrarySet flexLibrarySet=(FlexLibrarySet)librarySets.get(key);
  if (flexLibrarySet == null) {
    final Set<CharSequence> globalDefinitions=getGlobalDefinitions(libraryCollector.getGlobalLibrary());
    final int id=librarySetIdPool.allocate();
    final SortResult sortResult=sortLibraries(new LibrarySorter(new FlexDefinitionProcessor(),new FlexDefinitionMapPostProcessor(libraryCollector.getFlexSdkVersion())),id,libraryCollector.sdkLibraries,libraryCollector.getFlexSdkVersion(),new Condition<String>(){
      @Override public boolean value(      String name){
        return globalDefinitions.contains(name);
      }
    }
);
    flexLibrarySet=new FlexLibrarySet(id,null,sortResult.items,sortResult.resourceBundleOnlyItems,new ContainsCondition(globalDefinitions,sortResult.definitionMap));
    Client.getInstance().registerLibrarySet(flexLibrarySet);
    librarySets.put(key,flexLibrarySet);
  }
  return flexLibrarySet;
}
