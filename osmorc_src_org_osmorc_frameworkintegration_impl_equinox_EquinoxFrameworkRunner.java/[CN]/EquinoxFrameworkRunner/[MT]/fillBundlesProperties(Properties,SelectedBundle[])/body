{
  StringBuilder osgiBundlesBuilder=new StringBuilder();
  int level=0;
  for (  SelectedBundle selectedBundle : bundlesToInstall) {
    String bundleUrl=selectedBundle.getBundleUrl();
    osgiBundlesBuilder.append("reference:");
    osgiBundlesBuilder.append(bundleUrl);
    if (selectedBundle.isStartAfterInstallation()) {
      osgiBundlesBuilder.append("@").append(selectedBundle.getStartLevel());
      if (!CachingBundleInfoProvider.isFragmentBundle(selectedBundle.getBundleUrl())) {
        osgiBundlesBuilder.append(":start");
      }
    }
    osgiBundlesBuilder.append(",");
    level=Math.max(level,selectedBundle.getStartLevel());
  }
  if (osgiBundlesBuilder.length() > 0) {
    osgiBundlesBuilder.delete(osgiBundlesBuilder.length() - 1,osgiBundlesBuilder.length());
  }
  String osgiBundles=osgiBundlesBuilder.toString();
  properties.put("osgi.bundles",osgiBundles);
  properties.put("osgi.bundles.defaultStartLevel","4");
  properties.put("osgi.framework.beginningstartlevel",String.valueOf(level));
  properties.put("osgi.startLevel",String.valueOf(level));
}
