{
  JsTestDriverBuilder builder=new JsTestDriverBuilder();
  final ParsedConfiguration parsedConfiguration;
  try {
    parsedConfiguration=JstdConfigParsingUtils.parseConfiguration(configFile);
  }
 catch (  Exception e) {
    throw new ConfigurationException("Configuration file parsing failed.\n" + "See http://code.google.com/p/js-test-driver/wiki/ConfigurationFile for clarification.\n\n" + "Details:",e);
  }
  final File singleBasePath=JstdConfigParsingUtils.getSingleBasePath(parsedConfiguration.getBasePaths(),configFile);
  myTreeManager.setCurrentBasePath(singleBasePath.getAbsolutePath());
  wipeCoveragePlugin(parsedConfiguration);
  builder.setDefaultConfiguration(parsedConfiguration);
  builder.withPluginInitializer(new PluginInitializer(){
    @Override public Module initializeModule(    Flags flags,    Configuration config){
      return new AbstractModule(){
        @Override public void configure(){
          Multibinder<TestListener> testListeners=Multibinder.newSetBinder(binder(),TestListener.class);
          testListeners.addBinding().to(TestResultHolder.class);
          testListeners.addBinding().toInstance(new IdeaTestListener(myTreeManager,configFile,singleBasePath));
        }
      }
;
    }
  }
);
  builder.setRunnerMode(RunnerMode.QUIET);
  builder.setServer(mySettings.getServerUrl());
  List<String> flagArgs=Lists.newArrayList("--captureConsole","--server",mySettings.getServerUrl());
  flagArgs.addAll(Arrays.asList(extraArgs));
  List<String> coverageExcludedFiles=null;
  File emptyOutputDir=null;
  boolean runCoverage=false;
  if (myCoverageSession != null && !dryRun) {
    emptyOutputDir=createTempDir();
    if (emptyOutputDir != null) {
      flagArgs.add("--testOutput");
      flagArgs.add(emptyOutputDir.getAbsolutePath());
      List<String> testPaths=getTestFilePaths(parsedConfiguration);
      coverageExcludedFiles=Lists.newArrayList(testPaths);
      coverageExcludedFiles.addAll(mySettings.getFilesExcludedFromCoverage());
      PluginInitializer coverageInitializer=getCoverageInitializer(coverageExcludedFiles);
      if (coverageInitializer != null) {
        builder.withPluginInitializer(coverageInitializer);
        builder.withPluginInitializer(new DependenciesTouchFix());
        runCoverage=true;
      }
    }
  }
  builder.setFlags(toStringArray(flagArgs));
  JsTestDriver jstd=builder.build();
  jstd.runConfiguration();
  if (runCoverage) {
    File[] coverageReportFiles=emptyOutputDir.listFiles(new FilenameFilter(){
      @Override public boolean accept(      File dir,      String name){
        return name.endsWith("-coverage.dat");
      }
    }
);
    if (coverageReportFiles != null && coverageReportFiles.length == 1) {
      try {
        CoverageReport coverageReport=CoverageSerializationUtils.readLCOV(coverageReportFiles[0]);
        for (        String excludedPath : coverageExcludedFiles) {
          coverageReport.clearReportByFilePath(excludedPath);
        }
        myCoverageSession.mergeReport(coverageReport);
      }
 catch (      Exception e) {
        myTreeManager.printThrowable(e);
      }
    }
  }
}
