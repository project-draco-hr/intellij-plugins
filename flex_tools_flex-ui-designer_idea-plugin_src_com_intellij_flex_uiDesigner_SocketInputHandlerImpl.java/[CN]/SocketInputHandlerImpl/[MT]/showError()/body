{
  final String userMessage=reader.readUTF();
  final String message=reader.readUTF();
  final String logMessage;
  Project project=null;
  if (reader.readBoolean()) {
    StringBuilder builder=StringBuilderSpinAllocator.alloc();
    try {
      project=readProject();
      final VirtualFile file=DocumentFactoryManager.getInstance(project).getFile(reader.readUnsignedShort());
      builder.append(message);
      builder.append("\nFile: ").append(file.getPath()).append("\nFile content: \n").append(LoadTextUtil.loadText(file));
      logMessage=builder.toString();
    }
  finally {
      StringBuilderSpinAllocator.dispose(builder);
    }
  }
 else {
    logMessage=message;
  }
  LOG.error(logMessage,new Throwable(){
    @Override public void printStackTrace(    PrintStream s){
    }
    @Override public Throwable fillInStackTrace(){
      return this;
    }
  }
);
  if (!userMessage.isEmpty()) {
    DocumentProblemManager.getInstance().report(project,userMessage + "<br><br>" + message);
  }
}
