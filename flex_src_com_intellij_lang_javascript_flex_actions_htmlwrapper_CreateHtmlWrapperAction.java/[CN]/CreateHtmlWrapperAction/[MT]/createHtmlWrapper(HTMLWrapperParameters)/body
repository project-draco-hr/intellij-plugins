{
  final Ref<IOException> exceptionRef=new Ref<IOException>();
  final VirtualFile htmlFile=ApplicationManager.getApplication().runWriteAction(new NullableComputable<VirtualFile>(){
    public VirtualFile compute(){
      try {
        VirtualFile _htmlFile=null;
        for (        final VirtualFile file : parameters.getHtmlWrapperRootDir().getChildren()) {
          if (file.getName().equals(HTML_WRAPPER_TEMPLATE_FILE_NAME)) {
            final Properties attributes=new Properties();
            attributes.setProperty(HTML_PAGE_TITLE,parameters.getHtmlPageTitle());
            attributes.setProperty(FLEX_APPLICATION_NAME,parameters.getFlexApplicationName());
            attributes.setProperty(SWF_FILE_NAME,parameters.getSwfFileName());
            attributes.setProperty(APPLICATION_WIDTH,parameters.getApplicationWidth());
            attributes.setProperty(APPLICATION_HEIGHT,parameters.getApplicationHeight());
            attributes.setProperty(BG_COLOR,parameters.getBgColor());
            attributes.setProperty(REQUIRED_FLASH_PLAYER_VERSION_MAJOR,String.valueOf(parameters.getFlashPlayerVersionMajor()));
            attributes.setProperty(REQUIRED_FLASH_PLAYER_VERSION_MINOR,String.valueOf(parameters.getFlashPlayerVersionMinor()));
            attributes.setProperty(REQUIRED_FLASH_PLAYER_VERSION_REVISION,String.valueOf(parameters.getFlashPlayerVersionRevision()));
            final String resultText=FileTemplateUtil.mergeTemplate(attributes,VfsUtil.loadText(file),true);
            _htmlFile=FlexUtils.addFileWithContent(parameters.getHtmlFileName(),resultText,parameters.getHtmlFileLocation());
          }
 else {
            file.copy(null,parameters.getHtmlFileLocation(),file.getName());
          }
        }
        return _htmlFile;
      }
 catch (      IOException e) {
        exceptionRef.set(e);
        return null;
      }
    }
  }
);
  if (!exceptionRef.isNull()) {
    throw exceptionRef.get();
  }
  return htmlFile;
}
