{
  myFile=null;
  myEditor=null;
  final File toDirIO=createTempDirectory();
  final VirtualFile toDir=getVirtualFile(toDirIO);
  AccessToken token=WriteAction.start();
  try {
    final ModuleRootManager rootManager=ModuleRootManager.getInstance(myModule);
    final ModifiableRootModel rootModel=rootManager.getModifiableModel();
    final boolean rootSpecified=rawProjectRoot != null;
    final int rawRootPathLength=rootSpecified ? rawProjectRoot.getPath().length() : -1;
    for (int i=vFiles.length - 1; i >= 0; i--) {
      VirtualFile vFile=vFiles[i];
      if (rootSpecified) {
        copyFilesFillingEditorInfos(rawProjectRoot,toDir,vFile.getPath().substring(rawRootPathLength));
      }
 else {
        copyFilesFillingEditorInfos(vFile.getParent(),toDir,vFile.getName());
      }
    }
    rootModel.addContentEntry(toDir).addSourceFolder(toDir,false);
    modifyModule(rootModel,toDir);
    doCommitModel(rootModel);
    sourceRootAdded(toDir);
  }
 catch (  IOException e) {
    LOG.error(e);
  }
 finally {
    token.finish();
  }
  runAdl();
  return toDir;
}
