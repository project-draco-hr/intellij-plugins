{
  FileDocumentManager.getInstance().saveAllDocuments();
  final ExecutionResult executionResult=state.execute(environment.getExecutor(),this);
  if (executionResult == null) {
    return Promise.resolve(null);
  }
  final KarmaConsoleView consoleView=KarmaConsoleView.get(executionResult,state);
  if (consoleView == null) {
    return Promise.resolve(KarmaUtil.createDefaultRunProfileStarter(executionResult));
  }
  final KarmaServer karmaServer=consoleView.getKarmaExecutionSession().getKarmaServer();
  if (karmaServer.areBrowsersReady()) {
    KarmaDebugBrowserSelector browserSelector=new KarmaDebugBrowserSelector(karmaServer.getCapturedBrowsers(),environment,consoleView);
    final DebuggableWebBrowser debuggableWebBrowser=browserSelector.selectDebugEngine();
    return prepareDebugger(environment.getProject(),debuggableWebBrowser,new RunProfileStarter(){
      @Nullable @Override public RunContentDescriptor execute(      @NotNull RunProfileState state,      @NotNull ExecutionEnvironment env) throws ExecutionException {
        if (debuggableWebBrowser == null) {
          return new RunContentBuilder(executionResult,env).showRunContent(env.getContentToReuse());
        }
        final Url url=Urls.newFromEncoded(karmaServer.formatUrl("/debug.html"));
        final DebuggableFileFinder fileFinder=getDebuggableFileFinder(karmaServer);
        XDebugSession session=XDebuggerManager.getInstance(env.getProject()).startSession(env,new XDebugProcessStarter(){
          @Override @NotNull public XDebugProcess start(          @NotNull final XDebugSession session){
            JavaScriptDebugEngine debugEngine=debuggableWebBrowser.getDebugEngine();
            WebBrowser browser=debuggableWebBrowser.getWebBrowser();
            JavaScriptDebugProcess<? extends VmConnection> debugProcess=debugEngine.createDebugProcess(session,browser,fileFinder,url,executionResult,true);
            debugProcess.setElementsInspectorEnabled(false);
            debugProcess.setLayouter(consoleView.createDebugLayouter(debugProcess));
            return debugProcess;
          }
        }
);
        return session.getRunContentDescriptor();
      }
    }
);
  }
 else {
    return Promise.<RunProfileStarter>resolve(new RunProfileStarter(){
      @Nullable @Override public RunContentDescriptor execute(      @NotNull RunProfileState state,      @NotNull ExecutionEnvironment env){
        final RunContentDescriptor descriptor=KarmaUtil.createDefaultDescriptor(executionResult,env);
        karmaServer.onBrowsersReady(new Runnable(){
          @Override public void run(){
            ExecutionUtil.restartIfActive(descriptor);
          }
        }
);
        return descriptor;
      }
    }
);
  }
}
