{
  final ExecutionResult executionResult=state.execute(environment.getExecutor(),this);
  if (executionResult == null) {
    return new AsyncResult<RunProfileStarter>().setDone(null);
  }
  final KarmaConsoleView consoleView=KarmaConsoleView.get(executionResult);
  if (consoleView == null) {
    throw new RuntimeException("KarmaConsoleView was expected!");
  }
  final KarmaServer karmaServer=consoleView.getKarmaExecutionSession().getKarmaServer();
  if (karmaServer.areBrowsersReady()) {
    final DebuggableWebBrowser debuggableWebBrowser=new KarmaDebugBrowserSelector(project,karmaServer.getCapturedBrowsers(),environment,this).selectDebugEngine();
    return prepareDebugger(project,debuggableWebBrowser,new RunProfileStarter(){
      @Nullable @Override public RunContentDescriptor execute(      @NotNull Project project,      @NotNull Executor executor,      @NotNull RunProfileState state,      @Nullable RunContentDescriptor contentToReuse,      @NotNull ExecutionEnvironment env) throws ExecutionException {
        if (debuggableWebBrowser == null) {
          return null;
        }
        final Url url=Urls.newFromEncoded(karmaServer.formatUrl("/debug.html"));
        final DebuggableFileFinder fileFinder=getDebuggableFileFinder(karmaServer);
        XDebugSession session=XDebuggerManager.getInstance(project).startSession(KarmaDebugProgramRunner.this,env,contentToReuse,new XDebugProcessStarter(){
          @Override @NotNull public XDebugProcess start(          @NotNull final XDebugSession session){
            JavaScriptDebugEngine debugEngine=debuggableWebBrowser.getDebugEngine();
            WebBrowser browser=debuggableWebBrowser.getWebBrowser();
            JSDebugProcess<?> debugProcess=debugEngine.createDebugProcess(session,browser,fileFinder,url,executionResult,true);
            debugProcess.setElementsInspectorEnabled(false);
            debugProcess.setLayouter(consoleView.createDebugLayouter(debugProcess));
            return debugProcess;
          }
        }
);
        return session.getRunContentDescriptor();
      }
    }
);
  }
 else {
    return AsyncResult.<RunProfileStarter>done(new RunProfileStarter(){
      @Nullable @Override public RunContentDescriptor execute(      @NotNull Project project,      @NotNull Executor executor,      @NotNull RunProfileState state,      @Nullable RunContentDescriptor contentToReuse,      @NotNull ExecutionEnvironment env){
        RunContentBuilder contentBuilder=new RunContentBuilder(KarmaDebugProgramRunner.this,executionResult,env);
        final RunContentDescriptor descriptor=contentBuilder.showRunContent(contentToReuse);
        karmaServer.onBrowsersReady(new Runnable(){
          @Override public void run(){
            KarmaUtil.restart(descriptor);
          }
        }
);
        return descriptor;
      }
    }
);
  }
}
