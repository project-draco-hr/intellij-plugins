{
  PrimitiveAmfOutputStream out=writer.getOut();
  if (instance.isWritten()) {
    writeDeferredInstanceKind(AmfExtendedTypes.OBJECT_REFERENCE,instance);
    out.writeUInt29(instance.id);
  }
 else {
    if (instance.overrideUserCount > 0) {
      writer.allocateObjectId(instance);
    }
    if (instance.id == -1) {
      writeDeferredInstanceKind(ObjectMetadata.NEVER_REFERRED,instance);
    }
 else {
      writeDeferredInstanceKind(ObjectMetadata.REFERRED,instance);
      instance.markAsWritten();
    }
    final int referredObjectsCount=instance.getReferredObjectsCount();
    out.writeUInt29(writer.getBlockOut().getDataRangeOwnLength(instance.getDataRange()) + IOUtil.uint29SizeOf(referredObjectsCount));
    out.writeUInt29(referredObjectsCount);
    writer.getBlockOut().addMarker(new ByteRangeMarker(out.size(),instance.getDataRange()));
    if (instance.id != -1) {
      out.writeUInt29(instance.id);
    }
  }
}
