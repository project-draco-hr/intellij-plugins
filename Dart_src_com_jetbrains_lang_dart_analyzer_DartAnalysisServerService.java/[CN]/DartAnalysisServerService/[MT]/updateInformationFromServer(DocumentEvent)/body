{
  final Document document=e.getDocument();
  final VirtualFile file=FileDocumentManager.getInstance().getFile(document);
  if (!isLocalDartOrHtmlFile(file))   return;
  final String filePath=file.getPath();
  myFilePathsWithUnsentChanges.add(filePath);
synchronized (myNavigationData) {
    final List<PluginNavigationRegion> regions=myNavigationData.get(filePath);
    if (regions != null) {
      final int eventOffset=e.getOffset();
      final int deltaLength=e.getNewLength() - e.getOldLength();
      final Iterator<PluginNavigationRegion> iterator=regions.iterator();
      while (iterator.hasNext()) {
        final PluginNavigationRegion region=iterator.next();
        for (        PluginNavigationTarget target : region.getTargets()) {
          if (target.file.equals(filePath) && target.offset >= eventOffset) {
            target.offset+=deltaLength;
          }
        }
        if (deltaLength > 0) {
          if (eventOffset <= region.offset) {
            region.offset+=deltaLength;
          }
 else           if (region.offset < eventOffset && eventOffset < region.offset + region.length) {
            iterator.remove();
          }
        }
 else         if (deltaLength < 0) {
          final int eventRightOffset=eventOffset - deltaLength;
          if (eventRightOffset <= region.offset) {
            region.offset+=deltaLength;
          }
 else           if (eventOffset < region.offset + region.length) {
            iterator.remove();
          }
        }
      }
    }
  }
synchronized (myHighlightData) {
    final List<PluginHighlightRegion> regions=myHighlightData.get(filePath);
    if (regions != null) {
      final int eventOffset=e.getOffset();
      final int deltaLength=e.getNewLength() - e.getOldLength();
      final Iterator<PluginHighlightRegion> iterator=regions.iterator();
      while (iterator.hasNext()) {
        final PluginHighlightRegion region=iterator.next();
        if (deltaLength > 0) {
          if (eventOffset <= region.offset) {
            region.offset+=deltaLength;
          }
 else           if (region.offset < eventOffset && eventOffset < region.offset + region.length) {
            region.length+=deltaLength;
          }
        }
 else         if (deltaLength < 0) {
          final int eventRightOffset=eventOffset - deltaLength;
          final int regionRightOffset=region.offset + region.length;
          if (eventRightOffset <= region.offset) {
            region.offset+=deltaLength;
          }
 else           if (region.offset <= eventOffset && eventRightOffset <= regionRightOffset && region.length != -deltaLength) {
            region.length+=deltaLength;
          }
 else           if (eventOffset < regionRightOffset) {
            iterator.remove();
          }
        }
      }
    }
  }
}
