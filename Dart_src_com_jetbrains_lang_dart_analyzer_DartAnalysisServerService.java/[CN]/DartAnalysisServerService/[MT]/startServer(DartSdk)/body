{
synchronized (myLock) {
    mySdkHome=sdk.getHomePath();
    final String testSdkHome=System.getProperty("dart.sdk");
    if (ApplicationManager.getApplication().isUnitTestMode() && testSdkHome == null)     return;
    final String runtimePath=FileUtil.toSystemDependentName((ApplicationManager.getApplication().isUnitTestMode() ? testSdkHome : mySdkHome) + "/bin/dart");
    final String analysisServerPath=FileUtil.toSystemDependentName((ApplicationManager.getApplication().isUnitTestMode() ? testSdkHome : mySdkHome) + "/bin/snapshots/analysis_server.dart.snapshot");
    final DebugPrintStream debugStream=new DebugPrintStream(){
      @Override public void println(      String str){
      }
    }
;
    final int port=NetUtils.tryToFindAvailableSocketPort(10000);
    final StdioServerSocket serverSocket=new StdioServerSocket(runtimePath,analysisServerPath,null,debugStream,new String[]{},false,false,port,false,FileReadMode.NORMALIZE_EOL_ALWAYS);
    serverSocket.setClientId(ApplicationNamesInfo.getInstance().getFullProductName().replace(' ','_'));
    serverSocket.setClientVersion(ApplicationInfo.getInstance().getApiVersion());
    myServer=new RemoteAnalysisServerImpl(serverSocket);
    try {
      myServer.start();
      myListener=new ServerServiceAnalysisServerListener();
      myServer.addAnalysisServerListener(myListener);
      mySdkVersion=sdk.getVersion();
      myServer.analysis_updateOptions(new AnalysisOptions(true,true,true,false,true,false));
      LOG.info("Server started, see status at http://localhost:" + port + "/status");
    }
 catch (    Exception e) {
      LOG.warn("Failed to start Dart analysis server, port=" + port,e);
      onServerStopped();
    }
  }
}
