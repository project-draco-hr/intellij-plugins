{
synchronized (myLock) {
    mySdkHome=sdk.getHomePath();
    final String runtimePath=FileUtil.toSystemDependentName(mySdkHome + "/bin/dart");
    String analysisServerPath=FileUtil.toSystemDependentName(mySdkHome + "/bin/snapshots/analysis_server.dart.snapshot");
    analysisServerPath=System.getProperty("dart.server.path",analysisServerPath);
    final DebugPrintStream debugStream=new DebugPrintStream(){
      @Override public void println(      String str){
      }
    }
;
    final int port=NetUtils.tryToFindAvailableSocketPort(10000);
    String argsRaw;
    try {
      argsRaw=Registry.stringValue("dart.server.additional.arguments");
    }
 catch (    MissingResourceException e) {
      argsRaw="";
    }
    argsRaw+=" --useAnalysisHighlight2";
    myServerSocket=new StdioServerSocket(runtimePath,analysisServerPath,null,debugStream,ArrayUtil.toStringArray(StringUtil.split(argsRaw," ")),false,false,port,false,FileReadMode.NORMALIZE_EOL_ALWAYS);
    myServerSocket.setClientId(ApplicationNamesInfo.getInstance().getFullProductName().replace(' ','_'));
    myServerSocket.setClientVersion(ApplicationInfo.getInstance().getApiVersion());
    myServer=new RemoteAnalysisServerImpl(myServerSocket);
    try {
      myServer.start();
      myServer.server_setSubscriptions(SERVER_SUBSCRIPTIONS);
      if (Registry.is("dart.projects.without.pubspec",false)) {
        myServer.analysis_setGeneralSubscriptions(Collections.singletonList(GeneralAnalysisService.ANALYZED_FILES));
      }
      myServer.addAnalysisServerListener(myAnalysisServerListener);
      mySdkVersion=sdk.getVersion();
      myServer.analysis_updateOptions(new AnalysisOptions(true,true,true,true,false,true,false));
      LOG.info("Server started, see status at http://localhost:" + port + "/status");
    }
 catch (    Exception e) {
      LOG.warn("Failed to start Dart analysis server, port=" + port,e);
      stopServer();
    }
  }
}
