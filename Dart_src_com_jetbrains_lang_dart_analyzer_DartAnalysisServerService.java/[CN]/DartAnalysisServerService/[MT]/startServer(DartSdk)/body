{
synchronized (myLock) {
    mySdkHome=sdk.getHomePath();
    final String runtimePath=FileUtil.toSystemDependentName(mySdkHome + "/bin/dart");
    String analysisServerPath=FileUtil.toSystemDependentName(mySdkHome + "/bin/snapshots/analysis_server.dart.snapshot");
    analysisServerPath=System.getProperty("dart.server.path",analysisServerPath);
    final DebugPrintStream debugStream=new DebugPrintStream(){
      @Override public void println(      String str){
      }
    }
;
    final int port=NetUtils.tryToFindAvailableSocketPort(10000);
    String vmArgsRaw;
    try {
      vmArgsRaw=Registry.stringValue("dart.server.vm.options");
    }
 catch (    MissingResourceException e) {
      vmArgsRaw="";
    }
    String serverArgsRaw="";
    serverArgsRaw+=" --port=" + port;
    serverArgsRaw+=" --useAnalysisHighlight2";
    serverArgsRaw+=" --file-read-mode=normalize-eol-always";
    try {
      serverArgsRaw+=" " + Registry.stringValue("dart.server.additional.arguments");
    }
 catch (    MissingResourceException e) {
    }
    myServerSocket=new StdioServerSocket(runtimePath,StringUtil.split(vmArgsRaw," "),analysisServerPath,StringUtil.split(serverArgsRaw," "),debugStream);
    myServerSocket.setClientId(ApplicationNamesInfo.getInstance().getFullProductName().replace(' ','_'));
    myServerSocket.setClientVersion(ApplicationInfo.getInstance().getApiVersion());
    myServer=new RemoteAnalysisServerImpl(myServerSocket);
    try {
      myServer.start();
      myServer.server_setSubscriptions(SERVER_SUBSCRIPTIONS);
      if (Registry.is("dart.projects.without.pubspec",false)) {
        myServer.analysis_setGeneralSubscriptions(Collections.singletonList(GeneralAnalysisService.ANALYZED_FILES));
      }
      myServer.addAnalysisServerListener(myAnalysisServerListener);
      mySdkVersion=sdk.getVersion();
      myServer.analysis_updateOptions(new AnalysisOptions(true,true,true,true,true,false,true,false));
      LOG.info("Server started, see status at http://localhost:" + port + "/status");
    }
 catch (    Exception e) {
      LOG.warn("Failed to start Dart analysis server, port=" + port,e);
      stopServer();
    }
  }
}
