{
  File bndFile=getBndFile();
  File tempJarFile=new File(myOutputJarFile.getAbsolutePath() + ".tmp.jar");
  boolean useBundlorFile=myExtension.isUseBundlorFile();
  progressMessage("Running bnd to build the bundle");
  myBndWrapper.build(bndFile,useBundlorFile ? tempJarFile : myOutputJarFile);
  if (useBundlorFile) {
    progressMessage("Running bundlor to calculate the manifest");
    String bundlorFileLocation=myExtension.getBundlorFileLocation();
    File bundlorFile=myExtension.findFileInModuleContentRoots(bundlorFileLocation);
    if (bundlorFile == null) {
      throw new OsmorcBuildException("The Bundlor file for the module does not exist",bundlorFileLocation);
    }
    BundlorWrapper bw=new BundlorWrapper();
    try {
      bw.wrapModule(this,tempJarFile,bundlorFile);
    }
  finally {
      if (FileUtil.delete(tempJarFile)) {
        warn("Could not delete the temporary file",tempJarFile);
      }
    }
  }
  if (!myExtension.isUseBndFile() && !myExtension.isUseBundlorFile()) {
    bundlifyLibraries();
  }
}
