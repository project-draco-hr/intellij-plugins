{
  StartupManager.getInstance(myProject).runWhenProjectIsInitialized(new Runnable(){
    public void run(){
      final boolean dartSdkWasEnabledInOldModel=hasJSLibraryMappingToOldDartSdkGlobalLib(myProject);
      deleteDartSdkGlobalLibConfiguredInOldIde();
      final String dartSdkGlobalLibName=findOrCreateNewDartSdkGlobalLib();
      final Collection<VirtualFile> pubspecYamlFiles=FilenameIndex.getVirtualFilesByName(myProject,"pubspec.yaml",GlobalSearchScope.projectScope(myProject));
      for (      VirtualFile pubspecYamlFile : pubspecYamlFiles) {
        final Module module=ModuleUtilCore.findModuleForFile(pubspecYamlFile,myProject);
        if (module != null && FileTypeIndex.containsFileOfType(DartFileType.INSTANCE,module.getModuleContentScope())) {
          excludePackagesFolders(module,pubspecYamlFile);
          if (dartSdkGlobalLibName != null && dartSdkWasEnabledInOldModel && ModuleType.get(module) instanceof WebModuleTypeBase && !DartSdkGlobalLibUtil.isDartSdkGlobalLibAttached(module,dartSdkGlobalLibName)) {
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              public void run(){
                DartSdkGlobalLibUtil.configureDependencyOnGlobalLib(module,dartSdkGlobalLibName);
              }
            }
);
          }
        }
      }
    }
  }
);
}
