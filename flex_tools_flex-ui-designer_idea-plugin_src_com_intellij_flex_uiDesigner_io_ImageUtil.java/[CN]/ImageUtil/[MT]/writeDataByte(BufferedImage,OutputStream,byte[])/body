{
  int bufferLength=0;
  final DataBufferByte dataBuffer=(DataBufferByte)image.getRaster().getDataBuffer();
  final ColorModel colorModel=image.getColorModel();
  final byte[] data=dataBuffer.getData();
  for (int i=0, n=data.length; i < n; i++) {
    final byte pixel=data[i];
    byteBuffer[bufferLength++]=(byte)colorModel.getAlpha(pixel);
    byteBuffer[bufferLength++]=(byte)colorModel.getRed(pixel);
    byteBuffer[bufferLength++]=(byte)colorModel.getGreen(pixel);
    byteBuffer[bufferLength++]=(byte)colorModel.getBlue(pixel);
    if (bufferLength == MAX_BUFFER_LENGTH) {
      out.write(byteBuffer,0,bufferLength);
      bufferLength=0;
    }
  }
  return bufferLength;
}
