{
  final InputStream inputStream=virtualFile.getInputStream();
  final BufferedImage image;
  final Iterator<ImageReader> readers;
  if (mimeType == null) {
    readers=ImageIO.getImageReadersBySuffix(virtualFile.getExtension());
  }
 else {
    readers=ImageIO.getImageReadersByMIMEType(mimeType);
  }
  try {
    ImageReader reader=readers.next();
    if (reader.getFormatName().equals("UNKNOWN")) {
      reader=readers.next();
    }
    ImageInputStream imageInputStream=ImageIO.createImageInputStream(inputStream);
    reader.setInput(imageInputStream,true,true);
    try {
      image=reader.read(0,reader.getDefaultReadParam());
    }
  finally {
      reader.dispose();
      imageInputStream.close();
    }
  }
  finally {
    inputStream.close();
  }
  return image;
}
