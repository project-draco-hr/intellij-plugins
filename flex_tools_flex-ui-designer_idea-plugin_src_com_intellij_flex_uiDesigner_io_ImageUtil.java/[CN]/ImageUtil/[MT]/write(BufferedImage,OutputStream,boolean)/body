{
  final int width=image.getWidth();
  final int height=image.getHeight();
  final byte[] byteBuffer=BUFFER.get();
  IOUtil.writeShort(width,byteBuffer,0);
  IOUtil.writeShort(height,byteBuffer,2);
  byteBuffer[4]=(byte)(transparent ? 1 : 0);
  out.write(byteBuffer,0,5);
  WritableRaster raster=image.getRaster();
  final int nbands=raster.getNumBands();
  final int unflushedBufferLength;
  if (image.getType() == BufferedImage.TYPE_BYTE_INDEXED) {
    unflushedBufferLength=writeDataByte(image,out,byteBuffer);
  }
 else {
    if (raster.getDataBuffer().getNumBanks() != 1) {
      throw new IOException();
    }
    if (raster.getDataBuffer() instanceof DataBufferByte) {
      unflushedBufferLength=writeDataByte(image,out,byteBuffer,nbands);
    }
 else {
      unflushedBufferLength=writeDataInt(image,out,byteBuffer,nbands);
    }
  }
  if (unflushedBufferLength > 0) {
    out.write(byteBuffer,0,unflushedBufferLength);
  }
}
