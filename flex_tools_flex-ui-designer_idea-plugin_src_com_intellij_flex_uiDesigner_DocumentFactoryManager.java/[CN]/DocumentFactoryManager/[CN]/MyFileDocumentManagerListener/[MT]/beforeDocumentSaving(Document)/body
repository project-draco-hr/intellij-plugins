{
  final VirtualFile file=FileDocumentManager.getInstance().getFile(document);
  if (file == null) {
    return;
  }
  final DocumentInfo info=files.getNullableInfo(file);
  if (info == null) {
    return;
  }
  final DesignerApplicationManager designerApplicationManager=DesignerApplicationManager.getInstance();
  if (designerApplicationManager.isDocumentOpening()) {
    return;
  }
  if (info.documentModificationStamp == document.getModificationStamp()) {
    info.documentModificationStamp=-1;
    return;
  }
  final Project project=ProjectUtil.guessProjectForFile(file);
  if (project == null) {
    return;
  }
  final Module module=ModuleUtil.findModuleForFile(file,project);
  if (module == null) {
    return;
  }
  final XmlFile psiFile=(XmlFile)PsiDocumentManager.getInstance(project).getPsiFile(document);
  if (psiFile == null) {
    return;
  }
  designerApplicationManager.updateDocumentFactory(info.getId(),module,psiFile);
}
