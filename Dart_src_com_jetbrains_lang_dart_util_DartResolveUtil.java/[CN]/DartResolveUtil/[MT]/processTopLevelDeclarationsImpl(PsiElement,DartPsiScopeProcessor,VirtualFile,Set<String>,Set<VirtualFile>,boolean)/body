{
  if (virtualFile == null)   return false;
  if (processedFiles.contains(virtualFile)) {
    processor.processFilteredOutElementsForImportedFile(virtualFile);
    return true;
  }
  processedFiles.add(virtualFile);
  boolean contains=fileNames == null || fileNames.contains(virtualFile.getName());
  if (contains) {
    final PsiFile psiFile=context.getManager().findFile(virtualFile);
    for (    PsiElement root : findDartRoots(psiFile)) {
      if (!DartPsiCompositeElementImpl.processDeclarationsImpl(root,processor,ResolveState.initial(),null)) {
        return false;
      }
    }
  }
  for (  String partUrl : DartPathIndex.getPaths(context.getProject(),virtualFile)) {
    if (fileNames != null && !fileNames.contains(PathUtil.getFileName(partUrl))) {
      continue;
    }
    final VirtualFile childFile;
    if (partUrl.startsWith(DartUrlResolver.PACKAGE_PREFIX) || partUrl.startsWith(DartUrlResolver.FILE_PREFIX)) {
      childFile=DartUrlResolver.getInstance(context.getProject(),virtualFile).findFileByDartUrl(partUrl);
    }
 else {
      childFile=findRelativeFile(virtualFile,partUrl);
    }
    if (childFile == null || processedFiles.contains(childFile)) {
      continue;
    }
    final PsiFile childPsiFile=context.getManager().findFile(childFile);
    if (childPsiFile != null) {
      if (!processTopLevelDeclarationsImpl(childPsiFile,processor,childFile,fileNames,processedFiles)) {
        return false;
      }
    }
  }
  if (isLookingForPrivate) {
    return true;
  }
  final List<VirtualFile> libraryFiles=findLibrary(context.getContainingFile());
  final boolean processingLibraryWhereContextElementLocated=libraryFiles.contains(virtualFile);
  for (  DartImportOrExportInfo importOrExportInfo : DartImportAndExportIndex.getImportAndExportInfos(context.getProject(),virtualFile)) {
    if (processingLibraryWhereContextElementLocated && importOrExportInfo.getKind() == Kind.Export)     continue;
    if (!processingLibraryWhereContextElementLocated && importOrExportInfo.getKind() == Kind.Import)     continue;
    if (importOrExportInfo.getKind() == Kind.Import && importOrExportInfo.getImportPrefix() != null)     continue;
    final VirtualFile importedFile=getImportedFile(context.getProject(),virtualFile,importOrExportInfo.getUri());
    if (importedFile != null) {
      processor.importedFileProcessingStarted(importedFile,importOrExportInfo);
      final boolean continueProcessing=processTopLevelDeclarationsImpl(context,processor,importedFile,fileNames,processedFiles);
      processor.importedFileProcessingFinished(importedFile);
      if (!continueProcessing)       return false;
    }
  }
  return true;
}
