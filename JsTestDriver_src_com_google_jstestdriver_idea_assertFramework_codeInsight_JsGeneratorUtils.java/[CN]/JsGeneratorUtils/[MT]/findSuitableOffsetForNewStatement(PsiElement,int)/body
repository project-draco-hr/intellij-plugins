{
  PsiElement parent=psiElement.getParent();
  while (parent != null) {
    if (parent instanceof JSBlockStatement) {
      break;
    }
    if (parent instanceof PsiFile) {
      break;
    }
    psiElement=parent;
    parent=parent.getParent();
  }
  if (JsPsiUtils.isElementOfType(psiElement,JSTokenTypes.RBRACE)) {
    return psiElement.getTextRange().getStartOffset();
  }
  final TextRange whitespaceTextRange;
  if (JsPsiUtils.isElementOfType(psiElement,JSTokenTypes.WHITE_SPACE)) {
    whitespaceTextRange=psiElement.getTextRange();
  }
 else {
    whitespaceTextRange=unionFollowingWhitespaceTextRanges(psiElement);
  }
  if (whitespaceTextRange.containsOffset(caretOffset)) {
    return caretOffset;
  }
  return whitespaceTextRange.getStartOffset();
}
