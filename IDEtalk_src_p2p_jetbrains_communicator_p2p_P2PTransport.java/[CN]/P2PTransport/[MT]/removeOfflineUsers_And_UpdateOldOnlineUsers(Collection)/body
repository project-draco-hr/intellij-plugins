{
  for (final Iterator<User> it=myOnlineUsers.iterator(); it.hasNext(); ) {
    final User user=it.next();
    if (!onlineUsers.contains(user)) {
      myEventBroadcaster.doChange(new UserEvent.Offline(user),new Runnable(){
        @Override public void run(){
          it.remove();
          myUser2Info.remove(user);
        }
      }
);
    }
 else {
      UserPresence oldPresence=getNotNullOnlineInfo(user).getPresence();
      final OnlineUserInfo onlineUserInfo=myUser2InfoNew.get(user);
      if (onlineUserInfo == null)       return;
      UserPresence newPresence=onlineUserInfo.getPresence();
      if (!newPresence.equals(oldPresence)) {
        myEventBroadcaster.doChange(new UserEvent.Updated(user,"presence",oldPresence,newPresence),new Runnable(){
          @Override public void run(){
            myUser2Info.put(user,onlineUserInfo);
          }
        }
);
      }
 else {
        myUser2Info.put(user,onlineUserInfo);
      }
    }
  }
}
