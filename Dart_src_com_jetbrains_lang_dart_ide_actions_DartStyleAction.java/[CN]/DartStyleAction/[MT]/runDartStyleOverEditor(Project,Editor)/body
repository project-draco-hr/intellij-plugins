{
  final PsiFile psiFile=PsiUtilBase.getPsiFileInEditor(editor,project);
  if (psiFile == null)   return;
  final Runnable runnable=new Runnable(){
    public void run(){
      final Document document=editor.getDocument();
      final String path=FileUtil.toSystemDependentName(psiFile.getVirtualFile().getPath());
      int caretOffset=editor.getCaretModel().getOffset();
      DartAnalysisServerService.getInstance().updateFilesContent();
      DartAnalysisServerService.FormatResult formatResult=DartAnalysisServerService.getInstance().edit_format(path,caretOffset,0);
      if (formatResult != null && formatResult.getEdits() != null && formatResult.getEdits().size() == 1) {
        for (        SourceEdit edit : formatResult.getEdits()) {
          document.replaceString(0,document.getTextLength(),edit.getReplacement());
          editor.getCaretModel().moveToOffset(formatResult.getOffset());
        }
      }
    }
  }
;
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      CommandProcessor.getInstance().executeCommand(project,runnable,DART_STYLE_COMMAND_NAME,null);
    }
  }
);
}
