{
  if (dartFiles.isEmpty()) {
    Messages.showInfoMessage(project,DartBundle.message("dart.style.files.no.dart.files"),DartBundle.message("dart.style.action.name"));
    return;
  }
  if (Messages.showOkCancelDialog(project,DartBundle.message("dart.style.files.dialog.question",dartFiles.size()),DartBundle.message("dart.style.action.name"),null) != Messages.OK) {
    return;
  }
  final Map<VirtualFile,String> fileToNewContentMap=new THashMap<VirtualFile,String>();
  final int lineLength=getRightMargin(project);
  final Runnable runnable=new Runnable(){
    public void run(){
      double fraction=0.0;
      for (      final VirtualFile virtualFile : dartFiles) {
        fraction+=1.0;
        final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
        if (indicator != null) {
          indicator.checkCanceled();
          indicator.setFraction(fraction / dartFiles.size());
          indicator.setText2(FileUtil.toSystemDependentName(virtualFile.getPath()));
        }
        final String path=FileUtil.toSystemDependentName(virtualFile.getPath());
        final DartAnalysisServerService.FormatResult formatResult=DartAnalysisServerService.getInstance().edit_format(path,0,0,lineLength);
        if (formatResult != null && formatResult.getEdits() != null && formatResult.getEdits().size() == 1) {
          fileToNewContentMap.put(virtualFile,formatResult.getEdits().get(0).getReplacement());
        }
      }
    }
  }
;
  DartAnalysisServerService.getInstance().updateFilesContent();
  final boolean ok=ApplicationManagerEx.getApplicationEx().runProcessWithProgressSynchronously(runnable,DartBundle.message("dart.style.action.name"),true,project);
  if (ok) {
    final Runnable onSuccessRunnable=new Runnable(){
      @Override public void run(){
        CommandProcessor.getInstance().markCurrentCommandAsGlobal(project);
        for (        Map.Entry<VirtualFile,String> entry : fileToNewContentMap.entrySet()) {
          final VirtualFile file=entry.getKey();
          final Document document=FileDocumentManager.getInstance().getDocument(file);
          final String newContent=entry.getValue();
          if (document != null && newContent != null) {
            document.setText(newContent);
          }
        }
      }
    }
;
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        CommandProcessor.getInstance().executeCommand(project,onSuccessRunnable,DartBundle.message("dart.style.action.name"),null);
      }
    }
);
  }
}
