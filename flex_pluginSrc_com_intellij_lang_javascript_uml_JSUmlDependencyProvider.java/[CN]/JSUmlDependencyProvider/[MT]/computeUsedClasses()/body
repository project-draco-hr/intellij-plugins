{
  final Collection<Pair<JSClass,DiagramRelationshipInfo>> result=new ArrayList<Pair<JSClass,DiagramRelationshipInfo>>();
  final JSElementVisitor visitor=new JSElementVisitor(){
    boolean myInVariable;
    boolean myInNewExpression;
    boolean myInField;
    @Override public void visitJSReferenceExpression(    final JSReferenceExpression node){
      if (!myInVariable && !myInNewExpression) {
        return;
      }
      if (myInNewExpression && node.getParent() instanceof JSGenericSignature) {
        return;
      }
      PsiElement resolved=node.resolve();
      if (myInNewExpression && resolved instanceof JSFunction) {
        if (((JSFunction)resolved).isConstructor()) {
          resolved=JSResolveUtil.findParent(resolved);
        }
      }
      if (resolved instanceof JSClass) {
        DiagramRelationshipInfo relType;
        if (myInNewExpression) {
          relType=DiagramRelationships.CREATE;
        }
 else         if (myInField && node.getParent() instanceof JSGenericSignature) {
          relType=DiagramRelationships.TO_MANY;
        }
 else         if (myInField) {
          relType=DiagramRelationships.TO_ONE;
        }
 else {
          relType=DiagramRelationships.DEPENDENCY;
        }
        result.add(Pair.create((JSClass)resolved,relType));
      }
      super.visitJSReferenceExpression(node);
    }
    @Override public void visitJSVariable(    final JSVariable node){
      if (node instanceof JSParameter) {
        return;
      }
      myInVariable=true;
      myInField=JSResolveUtil.findParent(node) instanceof JSClass;
      try {
        super.visitJSVariable(node);
      }
  finally {
        myInVariable=false;
        myInField=false;
      }
    }
    @Override public void visitJSNewExpression(    final JSNewExpression node){
      myInNewExpression=true;
      try {
        super.visitJSNewExpression(node);
      }
  finally {
        myInNewExpression=false;
      }
    }
    @Override public void visitElement(    final PsiElement element){
      super.visitElement(element);
      element.acceptChildren(this);
    }
  }
;
  if (myClazz instanceof XmlBackedJSClassImpl) {
    ((XmlBackedJSClassImpl)myClazz).processInjectedFiles(new Processor<JSFile>(){
      @Override public boolean process(      final JSFile jsFile){
        jsFile.accept(visitor);
        return true;
      }
    }
);
    myClazz.getParent().acceptChildren(new XmlElementVisitor(){
      private boolean myInClassAttribute;
      @Override public void visitXmlTag(      final XmlTag tag){
        XmlElementDescriptor descriptor=tag.getDescriptor();
        if (descriptor != null) {
          PsiElement declaration=descriptor.getDeclaration();
          if (declaration instanceof XmlFile && JavaScriptSupportLoader.isFlexMxmFile((PsiFile)declaration)) {
            declaration=XmlBackedJSClassImpl.getXmlBackedClass((XmlFile)declaration);
          }
          if (declaration instanceof JSClass) {
            result.add(Pair.create((JSClass)declaration,DiagramRelationships.TO_ONE));
          }
        }
        super.visitXmlTag(tag);
      }
      @Override public void visitXmlAttribute(      final XmlAttribute attribute){
        XmlAttributeDescriptor descriptor=attribute.getDescriptor();
        if (descriptor instanceof AnnotationBackedDescriptor) {
          if (FlexReferenceContributor.isObjectType(((AnnotationBackedDescriptor)descriptor).getType())) {
            myInClassAttribute=true;
            try {
              super.visitXmlAttribute(attribute);
            }
  finally {
              myInClassAttribute=false;
            }
          }
        }
      }
      @Override public void visitXmlAttributeValue(      final XmlAttributeValue value){
        if (myInClassAttribute) {
          processReferenceSet(value.getReferences(),result,DiagramRelationships.TO_ONE);
        }
      }
      @Override public void visitXmlText(      final XmlText text){
        List<Pair<PsiElement,TextRange>> injectedFiles=InjectedLanguageUtil.getInjectedPsiFiles(text);
        if (injectedFiles != null) {
          for (          Pair<PsiElement,TextRange> pair : injectedFiles) {
            if (CSS.is(pair.first.getLanguage())) {
              pair.first.accept(new CssElementVisitor(){
                private boolean myInClassReference;
                @Override public void visitElement(                final PsiElement element){
                  super.visitElement(element);
                  element.acceptChildren(this);
                }
                @Override public void visitCssFunction(                final CssFunction _function){
                  if (FlexReferenceContributor.CLASS_REFERENCE.equals(_function.getFunctionName())) {
                    myInClassReference=true;
                    try {
                      super.visitCssFunction(_function);
                    }
  finally {
                      myInClassReference=false;
                    }
                  }
                }
                @Override public void visitCssString(                final CssString _string){
                  if (myInClassReference) {
                    processReferenceSet(_string.getReferences(),result,DiagramRelationships.DEPENDENCY);
                  }
                }
              }
);
            }
          }
        }
        super.visitXmlText(text);
      }
      @Override public void visitElement(      final PsiElement element){
        super.visitElement(element);
        element.acceptChildren(this);
      }
    }
);
  }
  myClazz.processDeclarations(new BaseScopeProcessor(){
    @Override public boolean execute(    final PsiElement element,    final ResolveState state){
      element.accept(visitor);
      return true;
    }
  }
,ResolveState.initial(),myClazz,myClazz);
  return result;
}
