{
  final String sdkHome;
  if (realSdk) {
    sdkHome=System.getProperty("dart.sdk");
    if (sdkHome == null) {
      Assert.fail("To run tests that use Dart Analysis Server you need to add '-Ddart.sdk=[real SDK home]' to the VM Options field of " + "the corresponding JUnit run configuration (Run | Edit Configurations)");
    }
    if (!DartSdkUtil.isDartSdkHome(sdkHome)) {
      Assert.fail("Incorrect path to the Dart SDK (" + sdkHome + ") is set as '-Ddart.sdk' VM option of "+ "the corresponding JUnit run configuration (Run | Edit Configurations)");
    }
    VfsRootAccess.allowRootAccessTemporarily(disposable,sdkHome);
  }
 else {
    sdkHome=SDK_HOME_PATH;
  }
  final String dartSdkGlobalLibName;
  final DartSdk sdk=DartSdk.getGlobalDartSdk();
  if (sdk != null && sdk.getHomePath().equals(sdkHome)) {
    dartSdkGlobalLibName=sdk.getGlobalLibName();
  }
 else {
    dartSdkGlobalLibName=ApplicationManager.getApplication().runWriteAction(new Computable<String>(){
      public String compute(){
        if (sdk != null) {
          DartSdkGlobalLibUtil.updateDartSdkGlobalLib(module.getProject(),sdk.getGlobalLibName(),sdkHome);
          return sdk.getGlobalLibName();
        }
 else {
          return DartSdkGlobalLibUtil.createDartSdkGlobalLib(module.getProject(),sdkHome);
        }
      }
    }
);
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      DartSdkGlobalLibUtil.configureDependencyOnGlobalLib(module,dartSdkGlobalLibName);
    }
  }
);
  Disposer.register(disposable,new Disposable(){
    @Override public void dispose(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          if (!module.isDisposed()) {
            DartSdkGlobalLibUtil.detachDartSdkGlobalLib(Collections.singletonList(module),dartSdkGlobalLibName);
          }
          LibraryTable.ModifiableModel model=ApplicationLibraryTable.getApplicationTable().getModifiableModel();
          Library library=model.getLibraryByName(dartSdkGlobalLibName);
          if (library != null) {
            model.removeLibrary(library);
            model.commit();
          }
        }
      }
);
    }
  }
);
}
