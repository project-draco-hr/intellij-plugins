{
  FileDocumentManager.getInstance().saveAllDocuments();
  ExecutionResult executionResult=state.execute(env.getExecutor(),this);
  if (executionResult == null) {
    return null;
  }
  KarmaConsoleView consoleView=KarmaConsoleView.get(executionResult);
  if (consoleView == null) {
    throw new RuntimeException("KarmaConsoleView was expected!");
  }
  final KarmaServer karmaServer=consoleView.getKarmaExecutionSession().getKarmaServer();
  if (karmaServer.getCoveragePeer().isKarmaCoveragePluginMissing()) {
    Messages.showErrorDialog(project,"<html><body>To gather coverage info, karma-coverage node package is needed." + "<div style=\"padding-top:4px\">To install it, run the command:</div>" + "<pre><code> npm install karma-coverage</code></pre>"+ "</body></html>","Karma Coverage");
    return null;
  }
  if (karmaServer.isReady() && karmaServer.hasCapturedBrowsers()) {
    return doCoverage(project,executionResult,contentToReuse,env,karmaServer);
  }
  RunContentBuilder contentBuilder=new RunContentBuilder(this,executionResult,env);
  final RunContentDescriptor descriptor=contentBuilder.showRunContent(contentToReuse);
  karmaServer.doWhenReadyWithCapturedBrowser(new Runnable(){
    @Override public void run(){
      KarmaUtil.restart(descriptor);
    }
  }
);
  return descriptor;
}
