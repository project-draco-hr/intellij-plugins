{
  final KarmaRunConfiguration runConfiguration=(KarmaRunConfiguration)env.getRunProfile();
  CoverageEnabledConfiguration coverageEnabledConfiguration=CoverageEnabledConfiguration.getOrCreate(runConfiguration);
  CoverageHelper.resetCoverageSuit(runConfiguration);
  final String coverageFilePath=coverageEnabledConfiguration.getCoverageFilePath();
  if (coverageFilePath != null) {
    KarmaCoveragePeer coveragePeer=getCoveragePeer(server);
    coveragePeer.startCoverageSession(new KarmaCoverageSession(){
      @Override public void onCoverageSessionFinished(      @NotNull final File lcovFile){
        UIUtil.invokeLaterIfNeeded(new Runnable(){
          @Override public void run(){
            try {
              FileUtil.copy(lcovFile,new File(coverageFilePath));
            }
 catch (            IOException e) {
              LOG.error("Can't copy files from " + lcovFile.getAbsolutePath() + " to "+ coverageFilePath,e);
              return;
            }
            RunnerSettings runnerSettings=env.getRunnerSettings();
            if (runnerSettings != null) {
              KarmaCoverageRunner coverageRunner=KarmaCoverageRunner.getInstance();
              coverageRunner.setKarmaServer(server);
              CoverageDataManager.getInstance(env.getProject()).processGatheredCoverage(runConfiguration,runnerSettings);
            }
          }
        }
);
      }
    }
);
  }
  ExecutionResult executionResult=state.executeWithServer(env.getExecutor(),server);
  RunContentBuilder contentBuilder=new RunContentBuilder(executionResult,env);
  return contentBuilder.showRunContent(env.getContentToReuse());
}
