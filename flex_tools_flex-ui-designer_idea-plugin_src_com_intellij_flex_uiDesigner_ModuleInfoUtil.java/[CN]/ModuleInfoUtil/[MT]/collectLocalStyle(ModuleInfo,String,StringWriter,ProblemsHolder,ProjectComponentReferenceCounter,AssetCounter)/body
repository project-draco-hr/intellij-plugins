{
  final PsiDocumentManager psiDocumentManager=PsiDocumentManager.getInstance(moduleInfo.getModule().getProject());
  if (psiDocumentManager.hasUncommitedDocuments()) {
    final Semaphore semaphore=new Semaphore();
    semaphore.down();
    Application application=ApplicationManager.getApplication();
    if (application.isDispatchThread()) {
      LogMessageUtil.LOG.error("must be not called in EDT");
    }
    application.invokeLater(new Runnable(){
      @Override public void run(){
        psiDocumentManager.performWhenAllCommitted(new Runnable(){
          @Override public void run(){
            semaphore.up();
          }
        }
);
      }
    }
);
    semaphore.waitFor();
  }
  final AccessToken token=ReadAction.start();
  try {
    if (moduleInfo.isApp()) {
      collectApplicationLocalStyle(moduleInfo,flexSdkVersion,problemsHolder,stringWriter,projectComponentReferenceCounter,assetCounter);
    }
 else {
      collectLibraryLocalStyle(moduleInfo,stringWriter,problemsHolder,projectComponentReferenceCounter,assetCounter);
    }
  }
  finally {
    token.finish();
  }
}
