{
  GeneralCommandLine commandLine=new GeneralCommandLine();
  KarmaRunSettings runSettings=serverSettings.getRunSettings();
  commandLine.setPassParentEnvironment(runSettings.isPassParentEnvVars());
  commandLine.getEnvironment().putAll(runSettings.getEnvVars());
  commandLine.withWorkDirectory(serverSettings.getConfigurationFile().getParentFile());
  commandLine.setExePath(serverSettings.getNodeInterpreterPath());
  File serverFile=myKarmaJsSourcesLocator.getServerAppFile();
  commandLine.addParameter(serverFile.getAbsolutePath());
  commandLine.addParameter("--karmaPackageDir=" + myKarmaJsSourcesLocator.getKarmaPackageDir().getAbsolutePath());
  commandLine.addParameter("--configFile=" + serverSettings.getConfigurationFilePath());
  String browsers=serverSettings.getRunSettings().getBrowsers();
  if (!StringUtil.isEmptyOrSpaces(browsers)) {
    commandLine.addParameter("--browsers=" + browsers);
  }
  if (myCoveragePeer != null) {
    commandLine.addParameter("--coverageTempDir=" + myCoveragePeer.getCoverageTempDir());
  }
  final Process process;
  try {
    process=commandLine.createProcess();
  }
 catch (  ExecutionException e) {
    throw new IOException("Can not start Karma server: " + commandLine.getCommandLineString(),e);
  }
  final int processHashCode=System.identityHashCode(process);
  LOG.info("Karma server " + processHashCode + " started successfully: "+ commandLine.getCommandLineString());
  KillableColoredProcessHandler processHandler=new KillableColoredProcessHandler(process,commandLine.getCommandLineString(),CharsetToolkit.UTF8_CHARSET);
  processHandler.addProcessListener(new ProcessAdapter(){
    @Override public void processTerminated(    final ProcessEvent event){
      LOG.info("Karma server " + processHashCode + " terminated with exit code "+ event.getExitCode());
      Disposer.dispose(myDisposable);
      fireOnTerminated(event.getExitCode());
    }
  }
);
  ProcessTerminatedListener.attach(processHandler);
  processHandler.setShouldDestroyProcessRecursively(true);
  return processHandler;
}
