{
  final File projectDir=extractProject(projectName,projectDirPath);
  new WriteAction(){
    @Override protected void run(    @NotNull Result result) throws Throwable {
      VirtualFile virtualDir=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(projectDir);
      assertNotNull("Directory not found: " + projectDir,virtualDir);
      virtualDir.refresh(false,true);
      for (      File moduleDir : projectDir.listFiles(VISIBLE_DIR_FILTER)) {
        String moduleDirPath=moduleDir.getPath().replace(File.separatorChar,'/') + "/";
        String moduleFileName=moduleDirPath + moduleDir.getName() + ".iml";
        if (new File(moduleFileName).exists()) {
          LocalFileSystem.getInstance().refreshAndFindFileByPath(moduleFileName);
          Module module=ModuleManager.getInstance(project).loadModule(moduleFileName);
          VirtualFile file=LocalFileSystem.getInstance().findFileByPath(moduleDirPath);
          assertNotNull(moduleDirPath,file);
          PsiTestUtil.addContentRoot(module,file);
          PsiTestUtil.addSourceRoot(module,file.findChild("src"));
        }
      }
    }
  }
.execute().throwException();
}
