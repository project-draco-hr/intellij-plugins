{
  Map<String,String> props=new HashMap<String,String>();
  int level=0;
  for (  SelectedBundle bundle : bundlesToInstall) {
    int startLevel=bundle.getStartLevel();
    level=Math.max(level,startLevel);
    String installBundles=props.get("osgi.auto.install");
    String bundleUrl=bundle.getBundleUrl();
    if (bundleUrl != null) {
      bundleUrl=bundleUrl.replaceAll(" ","%20");
    }
    installBundles=installBundles != null ? installBundles + " " + bundleUrl : bundleUrl;
    String startBundles=props.get("osgi.auto.start");
    if (bundle.isStartAfterInstallation() && !CachingBundleInfoProvider.isFragmentBundle(bundleUrl)) {
      startBundles=startBundles != null ? startBundles + " " + bundleUrl : bundleUrl;
    }
    if (installBundles != null) {
      props.put("osgi.auto.install",installBundles);
    }
    if (startBundles != null) {
      props.put("osgi.auto.start",startBundles);
    }
  }
  props.put("osgi.startlevel.framework",String.valueOf(level));
  props.put("osgi.init","true");
  props.put("ch.ethz.iks.concierge.storage",getFrameworkDirCanonicalPath());
  if (runProperties.isDebugMode()) {
    props.put("ch.ethz.iks.concierge.debug","true");
  }
  return props;
}
