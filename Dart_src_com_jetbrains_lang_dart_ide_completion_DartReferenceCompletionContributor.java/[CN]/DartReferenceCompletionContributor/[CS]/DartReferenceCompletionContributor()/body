{
  final PsiElementPattern.Capture<PsiElement> idInReference=psiElement().withSuperParent(1,DartId.class).withSuperParent(2,DartReference.class);
  extend(CompletionType.BASIC,idInReference.andNot(psiElement().withSuperParent(3,DartLibraryReferenceList.class)),new CompletionProvider<CompletionParameters>(){
    @Override protected void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext context,    @NotNull final CompletionResultSet resultSet){
      final DartReference reference=PsiTreeUtil.getParentOfType(parameters.getPosition(),DartReference.class);
      if (reference != null) {
        final Set<String> addedNames=DartReferenceCompletionContributor.addCompletionVariants(resultSet,reference);
        if (parameters.getInvocationCount() > 1 && DartResolveUtil.aloneOrFirstInChain(reference)) {
          DartGlobalVariantsCompletionHelper.addAdditionalGlobalVariants(resultSet,reference,addedNames,null);
        }
      }
    }
  }
);
  extend(CompletionType.BASIC,idInReference.withSuperParent(3,DartLibraryReferenceList.class),new CompletionProvider<CompletionParameters>(){
    @Override protected void addCompletions(    @NotNull CompletionParameters parameters,    ProcessingContext context,    @NotNull CompletionResultSet result){
      final DartImportOrExportStatement statement=PsiTreeUtil.getParentOfType(parameters.getPosition(),DartImportOrExportStatement.class);
      final VirtualFile vFile=parameters.getOriginalFile().getVirtualFile();
      if (statement != null && vFile != null) {
        final VirtualFile importedFile=DartResolveUtil.getImportedFile(statement.getProject(),vFile,statement.getUriString());
        if (importedFile != null) {
          final Set<DartComponentName> suggestedVariants=new THashSet<DartComponentName>();
          DartResolveUtil.processTopLevelDeclarations(statement,new ComponentNameScopeProcessor(suggestedVariants),importedFile,null);
          DartLookupElement.appendVariantsToCompletionSet(result,suggestedVariants,false);
        }
      }
    }
  }
);
}
