{
  if (!toolWindowVisible) {
    return;
  }
  final VirtualFile file=toolWindowForm.getFile();
  if (file == null) {
    return;
  }
  if (isSlow) {
    toolWindowForm.getPreviewPanel().getLoadingDecorator().startLoading(false);
    loadingDecoratorStarted++;
  }
  toolWindowForm.waitingForGetDocument.set(true);
  @SuppressWarnings("ConstantConditions") AsyncResult<BufferedImage> result=DesignerApplicationManager.getInstance().getDocumentImage((XmlFile)PsiManager.getInstance(project).findFile(file));
  result.doWhenDone(new QueuedAsyncResultHandler<BufferedImage>(){
    @Override protected boolean isExpired(){
      return toolWindowForm == null || !Comparing.equal(toolWindowForm.getFile(),file);
    }
    @Override public void process(    final BufferedImage image){
      UIUtil.invokeLaterIfNeeded(new Runnable(){
        @Override public void run(){
          toolWindowForm.getPreviewPanel().setImage(image);
        }
      }
);
    }
  }
);
  result.doWhenProcessed(new Runnable(){
    @Override public void run(){
      toolWindowForm.waitingForGetDocument.set(false);
      if (isSlow && --loadingDecoratorStarted == 0 && toolWindowForm != null) {
        toolWindowForm.getPreviewPanel().getLoadingDecorator().stopLoading();
      }
    }
  }
);
}
