{
  if (jdkForRun == null) {
    throw CantRunException.noJdkConfigured();
  }
  final JavaParameters params=new JavaParameters();
  params.setWorkingDirectory(runner.getWorkingDir());
  params.configureByProject(project,JavaParameters.JDK_ONLY,jdkForRun);
  PathsList classpath=params.getClassPath();
  for (  VirtualFile libraryFile : runner.getFrameworkStarterLibraries()) {
    classpath.add(libraryFile);
  }
  if (runConfiguration.isIncludeAllBundlesInClassPath()) {
    SelectedBundle[] bundles=getSelectedBundles();
    for (    SelectedBundle bundle : bundles) {
      String bundlePath=bundle.getBundleUrl();
      bundlePath=bundlePath.substring(FILE_URL_PREFIX.length());
      if (bundlePath.indexOf(':') < 0 && bundlePath.charAt(0) != '/') {
        bundlePath="/" + bundlePath;
      }
      bundlePath=bundlePath.replace('/',File.separatorChar);
      classpath.add(bundlePath);
    }
  }
  params.setMainClass(runner.getMainClass());
  final ParametersList programParameters=params.getProgramParametersList();
  SelectedBundle[] bundles=getSelectedBundles();
  if (bundles == null) {
    throw new CantRunException("One or more modules seem to be missing their OSGi facets. Please re-add the OSGi facets and try again.");
  }
  runner.fillCommandLineParameters(programParameters,bundles,runConfiguration.getVmParameters());
  programParameters.addParametersString(runConfiguration.getProgramParameters());
  if (!runner.launchesOwnVM()) {
    params.getVMParametersList().addParametersString(runConfiguration.getVmParameters());
  }
  Map<String,String> systemProperties=runner.getSystemProperties(bundles);
  for (  Map.Entry<String,String> entry : systemProperties.entrySet()) {
    params.getVMParametersList().defineProperty(entry.getKey(),entry.getValue());
  }
  return params;
}
