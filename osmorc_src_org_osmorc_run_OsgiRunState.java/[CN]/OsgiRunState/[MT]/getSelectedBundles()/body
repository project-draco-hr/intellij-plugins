{
  final Ref<List<SelectedBundle>> result=Ref.create();
  final Ref<ExecutionException> error=Ref.create();
  ProgressManager.getInstance().run(new Task.Modal(myRunConfiguration.getProject(),"Preparing bundles...",false){
    @Override public void run(    @NotNull ProgressIndicator progressIndicator){
      progressIndicator.setIndeterminate(false);
      try {
        Set<SelectedBundle> selectedBundles=new HashSet<SelectedBundle>();
        ModuleManager moduleManager=ModuleManager.getInstance(myRunConfiguration.getProject());
        int bundleCount=myRunConfiguration.getBundlesToDeploy().size();
        for (int i=0; i < bundleCount; i++) {
          progressIndicator.setFraction((double)i / bundleCount);
          SelectedBundle selectedBundle=myRunConfiguration.getBundlesToDeploy().get(i);
          if (selectedBundle.isModule()) {
            Module module=moduleManager.findModuleByName(selectedBundle.getName());
            if (module == null) {
              throw new CantRunException("Module '" + selectedBundle.getName() + "' does no longer exist."+ " Please check your run configuration.");
            }
            if (!OsmorcFacet.hasOsmorcFacet(module)) {
              throw new CantRunException("Module '" + selectedBundle.getName() + "' has no OSGi facet, but should have."+ " Please re-add the OSGi facet to this module.");
            }
            selectedBundle.setBundleUrl(new URL("file","/",BundleCompiler.getJarFileName(module)).toString());
            selectedBundles.add(selectedBundle);
            String[] depUrls=BundleCompiler.bundlifyLibraries(module,progressIndicator,DummyCompileContext.getInstance());
            for (            String depUrl : depUrls) {
              SelectedBundle dependency=new SelectedBundle("Dependency",depUrl,SelectedBundle.BundleType.PlainLibrary);
              selectedBundles.add(dependency);
            }
          }
 else {
            if (selectedBundles.contains(selectedBundle)) {
              selectedBundles.remove(selectedBundle);
            }
            selectedBundles.add(selectedBundle);
          }
        }
        Map<String,SelectedBundle> filteredBundles=new HashMap<String,SelectedBundle>();
        for (        SelectedBundle selectedBundle : selectedBundles) {
          String name=CachingBundleInfoProvider.getBundleSymbolicName(selectedBundle.getBundleUrl());
          String version=CachingBundleInfoProvider.getBundleVersions(selectedBundle.getBundleUrl());
          String key=name + version;
          if (!filteredBundles.containsKey(key)) {
            filteredBundles.put(key,selectedBundle);
          }
        }
        List<SelectedBundle> sortedBundles=ContainerUtil.newArrayList(filteredBundles.values());
        Collections.sort(sortedBundles,new StartLevelComparator());
        result.set(sortedBundles);
      }
 catch (      CantRunException e) {
        error.set(e);
      }
catch (      Throwable t) {
        error.set(new CantRunException("Internal error: " + t.getMessage()));
      }
    }
  }
);
  if (!result.isNull()) {
    return result.get();
  }
 else {
    throw error.get();
  }
}
