{
  out.write(AmfExtendedTypes.BINARY_FILE);
  int id=BinaryFileManager.getInstance().getId(virtualFile);
  if (id == -1) {
    id=BinaryFileManager.getInstance().add(virtualFile);
  }
 else {
    out.writeUInt29((id << 1) | 1);
    return;
  }
  out.writeUInt29(id << 1);
  final BufferedImage image;
  try {
    image=getImage();
  }
 catch (  IOException e) {
    LOG.error(e);
    return;
  }
  out.getBlockOut().addDirectMarker(2 + 2 + 1+ (image.getWidth() * image.getHeight() * 4),new MyDirectWriter(out.size(),image,mimeType == null ? virtualFile.getName().endsWith(".png") : mimeType.equals("image/png")));
}
