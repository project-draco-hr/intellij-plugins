{
  final RunProfile runConfiguration=env.getRunProfile();
  final VirtualFile contextFileOrDir;
  final ExecutionResult executionResult;
  final int debuggingPort;
  final int observatoryPort;
  if (runConfiguration instanceof DartRunConfigurationBase) {
    contextFileOrDir=((DartRunConfigurationBase)runConfiguration).getRunnerParameters().getDartFile();
    executionResult=state.execute(env.getExecutor(),this);
    if (executionResult == null) {
      return null;
    }
    debuggingPort=((DartCommandLineRunningState)state).getDebuggingPort();
    observatoryPort=((DartCommandLineRunningState)state).getObservatoryPort();
  }
 else   if (runConfiguration instanceof DartRemoteDebugConfiguration) {
    final String path=((DartRemoteDebugConfiguration)runConfiguration).getParameters().getDartProjectPath();
    contextFileOrDir=LocalFileSystem.getInstance().findFileByPath(path);
    if (contextFileOrDir == null) {
      throw new RuntimeConfigurationError("Folder not found: " + FileUtil.toSystemDependentName(path));
    }
    executionResult=null;
    debuggingPort=((DartRemoteDebugConfiguration)runConfiguration).getParameters().getPort();
    observatoryPort=-1;
  }
 else {
    LOG.error("Unexpected run configuration: " + runConfiguration.getClass().getName());
    return null;
  }
  FileDocumentManager.getInstance().saveAllDocuments();
  final XDebuggerManager debuggerManager=XDebuggerManager.getInstance(env.getProject());
  final XDebugSession debugSession=debuggerManager.startSession(env,new XDebugProcessStarter(){
    @Override @NotNull public XDebugProcess start(    @NotNull final XDebugSession session){
      final DartUrlResolver dartUrlResolver=DartUrlResolver.getInstance(env.getProject(),contextFileOrDir);
      return new DartCommandLineDebugProcess(session,debuggingPort,observatoryPort,executionResult,dartUrlResolver);
    }
  }
);
  return debugSession.getRunContentDescriptor();
}
