{
  final Map<TestRunner.ParameterKey,String> parameters=Maps.newHashMap();
  final String serverURL=runSettings.getServerType() == ServerType.INTERNAL ? "http://localhost:" + ToolPanel.serverPort : runSettings.getServerAddress();
  parameters.put(TestRunner.ParameterKey.SERVER_URL,serverURL);
  String joinedConfigPaths=joinConfigs(configVirtualFiles);
  parameters.put(TestRunner.ParameterKey.CONFIG_FILES,joinedConfigPaths);
  if (runSettings.getTestType() == TestType.TEST_CASE) {
    parameters.put(TestRunner.ParameterKey.TEST_CASE,runSettings.getTestCaseName());
  }
  if (runSettings.getTestType() == TestType.TEST_METHOD) {
    parameters.put(TestRunner.ParameterKey.TEST_CASE,runSettings.getTestCaseName());
    parameters.put(TestRunner.ParameterKey.TEST_METHOD,runSettings.getTestMethodName());
  }
  if (coverageFilePath != null) {
    parameters.put(TestRunner.ParameterKey.COVERAGE_OUTPUT_FILE,coverageFilePath);
    if (!runSettings.getFilesExcludedFromCoverage().isEmpty()) {
      String excludedPaths=EscapeUtils.join(runSettings.getFilesExcludedFromCoverage(),',');
      parameters.put(TestRunner.ParameterKey.COVERAGE_EXCLUDED_PATHS,excludedPaths);
    }
  }
  return buildCommandLine(parameters);
}
