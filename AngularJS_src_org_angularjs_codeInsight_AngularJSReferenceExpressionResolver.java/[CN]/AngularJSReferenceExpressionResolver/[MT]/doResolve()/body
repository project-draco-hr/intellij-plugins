{
  if (myReferencedName == null)   return ResolveResult.EMPTY_ARRAY;
  if (myRef.getParent() instanceof JSDefinitionExpression) {
    final AngularJSRepeatExpression repeat=PsiTreeUtil.getParentOfType(myRef,AngularJSRepeatExpression.class);
    if (repeat != null) {
      for (      JSDefinitionExpression def : repeat.getDefinitions()) {
        if (PsiTreeUtil.isAncestor(def,myRef,true))         return new JSResolveResult[]{new JSResolveResult(myRef)};
      }
    }
    final AngularJSAsExpression as=PsiTreeUtil.getParentOfType(myRef,AngularJSAsExpression.class);
    if (as != null) {
      if (PsiTreeUtil.isAncestor(as.getDefinition(),myRef,true))       return new JSResolveResult[]{new JSResolveResult(myRef)};
    }
    return ResolveResult.EMPTY_ARRAY;
  }
  if (AngularJSAsExpression.isAsControllerRef(myRef,myRef.getParent())) {
    final PsiElement resolve=AngularIndexUtil.resolve(myParent.getProject(),AngularControllerIndex.KEY,myReferencedName);
    if (resolve != null) {
      return new JSResolveResult[]{new JSResolveResult(resolve)};
    }
  }
 else   if (myQualifier == null) {
    final Collection<JSNamedElement> localVariables=getItemsByName(myReferencedName,myRef);
    if (!localVariables.isEmpty()) {
      return ContainerUtil.map2Array(localVariables,JSResolveResult.class,new Function<JSNamedElement,JSResolveResult>(){
        @Override public JSResolveResult fun(        JSNamedElement item){
          return new JSResolveResult(item);
        }
      }
);
    }
  }
  return super.doResolve();
}
