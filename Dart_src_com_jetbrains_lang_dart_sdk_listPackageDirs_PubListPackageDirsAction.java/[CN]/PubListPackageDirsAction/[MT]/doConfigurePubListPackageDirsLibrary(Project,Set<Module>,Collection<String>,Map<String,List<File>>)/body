{
  final Library library=createPubListPackageDirsLibrary(project,rootsToAddToLib,packageMap);
  for (  final Module module : ModuleManager.getInstance(project).getModules()) {
    final ModifiableRootModel modifiableModel=ModuleRootManager.getInstance(module).getModifiableModel();
    try {
      OrderEntry existingEntry=null;
      for (      final OrderEntry entry : modifiableModel.getOrderEntries()) {
        if (entry instanceof LibraryOrderEntry && LibraryTablesRegistrar.PROJECT_LEVEL.equals(((LibraryOrderEntry)entry).getLibraryLevel()) && DartPackagesLibraryType.DART_PACKAGES_LIBRARY_NAME.equals(((LibraryOrderEntry)entry).getLibraryName())) {
          existingEntry=entry;
          break;
        }
      }
      final boolean contains=existingEntry != null;
      final boolean mustContain=modules.contains(module);
      if (contains != mustContain) {
        if (mustContain) {
          modifiableModel.addLibraryEntry(library);
        }
 else {
          modifiableModel.removeOrderEntry(existingEntry);
        }
      }
      if (modifiableModel.isChanged()) {
        modifiableModel.commit();
      }
    }
  finally {
      if (!modifiableModel.isDisposed()) {
        modifiableModel.dispose();
      }
    }
  }
}
