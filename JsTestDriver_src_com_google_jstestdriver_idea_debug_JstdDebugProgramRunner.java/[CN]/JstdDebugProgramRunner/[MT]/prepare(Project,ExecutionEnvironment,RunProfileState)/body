{
  final JstdRunProfileState jstdState=JstdRunProfileState.cast(state);
  final JstdRunSettings runSettings=jstdState.getRunSettings();
  if (runSettings.isExternalServerType()) {
    throw new ExecutionException("JsTestDriver test can be debugged using local server running in IDE.");
  }
  JstdToolWindowManager jstdToolWindowManager=JstdToolWindowManager.getInstance(project);
  jstdToolWindowManager.setAvailable(true);
  JstdServer server=JstdServerRegistry.getInstance().getServer();
  final AsyncResult<RunProfileStarter> result=new AsyncResult<RunProfileStarter>();
  if (server != null && !server.isStopped()) {
    prepareWithServer(project,result,server,jstdState);
    return result;
  }
  jstdToolWindowManager.restartServer(new NullableConsumer<JstdServer>(){
    @Override public void consume(    @Nullable JstdServer server){
      if (server != null) {
        prepareWithServer(project,result,server,jstdState);
      }
 else {
        result.setDone(null);
      }
    }
  }
);
  return result;
}
