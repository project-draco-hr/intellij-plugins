{
  Project project=getEnvironment().getProject();
  DartSdk sdk=DartSdk.getDartSdk(project);
  if (sdk == null)   throw new ExecutionException("Dart SDK cannot be found");
  DartTestRunnerParameters params=(DartTestRunnerParameters)myRunnerParameters;
  StringBuilder builder=new StringBuilder();
  builder.append(RUN_COMMAND);
  final boolean projectWithoutPubspec=Registry.is("dart.projects.without.pubspec",false);
  final String targetName=params.getTargetName();
  final String testRunnerOptions=params.getTestRunnerOptions();
  if (projectWithoutPubspec && params.getScope() == Scope.FOLDER && targetName != null && !targetName.isEmpty()) {
    builder.append(" ").append(":").append(targetName).append(" ").append(EXPANDED_REPORTER_OPTION);
    if (testRunnerOptions != null && !testRunnerOptions.isEmpty()) {
      builder.append(" ").append(testRunnerOptions);
    }
  }
 else {
    builder.append(' ').append(TEST_PACKAGE_SPEC);
    builder.append(' ').append(EXPANDED_REPORTER_OPTION);
    if (testRunnerOptions != null && !testRunnerOptions.isEmpty()) {
      builder.append(" ").append(testRunnerOptions);
    }
    builder.append(' ').append(params.getFilePath());
    String testName=params.getTestName();
    if (testName != null && !testName.isEmpty() && params.getScope().expectsTestName()) {
      String safeName=StringUtil.escapeToRegexp(testName);
      builder.append(' ').append(NAME_REGEX_OPTION).append(' ').append('"').append(safeName).append('"');
    }
  }
  params.setArguments(builder.toString());
  params.setWorkingDirectory(params.computeProcessWorkingDirectory(project));
  return doStartProcess(pathToDartUrl(sdk.getHomePath() + PUB_SNAPSHOT_PATH));
}
