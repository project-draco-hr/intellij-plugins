{
  headerByteOutput=new ByteArrayOutputStreamEx(headerBufferSize);
  byteOutput=new ByteArrayOutputStreamEx(bodyBufferSize);
  headerOutput=new AmfOutputStream(headerByteOutput);
  out=new TransactionableAmfOutputStream(byteOutput);
  isReferenceTablesShared=sharedReferenceTablesOwner != null;
  if (isReferenceTablesShared) {
    if (sharedReferenceTablesOwner.headerOutput.stringTable == null) {
      sharedReferenceTablesOwner.headerOutput.stringTable=sharedReferenceTablesOwner.out.stringTable=new TransactionableStringIntHashMap();
    }
    if (sharedReferenceTablesOwner.headerOutput.traitsTable == null) {
      sharedReferenceTablesOwner.headerOutput.traitsTable=sharedReferenceTablesOwner.out.traitsTable=new TransactionableStringIntHashMap();
    }
    headerOutput.stringTable=out.stringTable=sharedReferenceTablesOwner.headerOutput.stringTable;
    headerOutput.traitsTable=out.traitsTable=sharedReferenceTablesOwner.headerOutput.traitsTable;
  }
}
